(window.webpackJsonp=window.webpackJsonp||[]).push([[122],{774:function(a,s,r){"use strict";r.r(s);var n=r(4),t=Object(n.a)({},(function(){var a=this,s=a.$createElement,r=a._self._c||s;return r("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[r("h2",{attrs:{id:"系统"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#系统"}},[a._v("#")]),a._v(" 系统")]),a._v(" "),r("h3",{attrs:{id:"学习目标"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#学习目标"}},[a._v("#")]),a._v(" 学习目标")]),a._v(" "),r("ul",[r("li",[r("p",[a._v("能够安装prometheus服务器")])]),a._v(" "),r("li",[r("p",[a._v("能够通过安装node_exporter监控远程linux")])]),a._v(" "),r("li",[r("p",[a._v("能够通过安装mysqld_exporter监控远程mysql数据库")])]),a._v(" "),r("li",[r("p",[a._v("能够安装grafana")])]),a._v(" "),r("li",[r("p",[a._v("能够在grafana添加prometheus数据源")])]),a._v(" "),r("li",[r("p",[a._v("能够在grafana添加监控cpu负载的图形")])]),a._v(" "),r("li",[r("p",[a._v("能够在grafana图形显示mysql监控数据")])]),a._v(" "),r("li",[r("p",[a._v("能够通过grafana+onealert实现报警")])])]),a._v(" "),r("h2",{attrs:{id:"任务背景"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#任务背景"}},[a._v("#")]),a._v(" 任务背景")]),a._v(" "),r("p",[a._v("某某某公司是一家电商网站，由于公司的业务快速发展，公司要求对现有")]),a._v(" "),r("p",[a._v("机器进行业务监控，责成运维部门来实施这个项目。")]),a._v(" "),r("h2",{attrs:{id:"任务要求"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#任务要求"}},[a._v("#")]),a._v(" 任务要求")]),a._v(" "),r("p",[a._v("1）部署监控服务器，实现7x24实时监控")]),a._v(" "),r("p",[a._v("2）针对公司的业务及研发部门设计监控系统，对监控项和触发器拿出合理")]),a._v(" "),r("p",[a._v("意见")]),a._v(" "),r("p",[a._v("3）做好问题预警机制，对可能出现的问题要及时告警并形成严格的处理机")]),a._v(" "),r("p",[a._v("制")]),a._v(" "),r("p",[a._v("4）做好监控告警系统，要求可以实现告警分级一级报警 电话通知")]),a._v(" "),r("p",[a._v("二级报警 微信通知")]),a._v(" "),r("p",[a._v("三级报警邮件通知")]),a._v(" "),r("p",[a._v("5）处理好公司服务器异地集中监控问题，K8S内部使用的监控系统就是普")]),a._v(" "),r("p",[a._v("罗米修斯")]),a._v(" "),r("h2",{attrs:{id:"任务分析"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#任务分析"}},[a._v("#")]),a._v(" 任务分析")]),a._v(" "),r("h4",{attrs:{id:"为什么要监控？"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#为什么要监控？"}},[a._v("#")]),a._v(" 为什么要监控？")]),a._v(" "),r("p",[a._v("答: 实时收集数据，通过报警及时发现问题，及时处理。数据为优化也可以")]),a._v(" "),r("p",[a._v("提供依据。")]),a._v(" "),r("h4",{attrs:{id:"监控四要素："}},[r("a",{staticClass:"header-anchor",attrs:{href:"#监控四要素："}},[a._v("#")]),a._v(" 监控四要素：")]),a._v(" "),r("p",[a._v("监控对象 [主机状态 服务 资源 页面，url]")]),a._v(" "),r("p",[a._v("用什么监控 [zabbix-server zabbix-agent] => 普罗米修斯监控")]),a._v(" "),r("p",[a._v("什么时间监控 [7x24 5x8]")]),a._v(" "),r("p",[a._v("报警给谁 [管理员]")]),a._v(" "),r("p",[a._v("项目选型：")]),a._v(" "),r("p",[a._v("mrtg (Multi Router Traffiffiffic Grapher)通过snmp协议得到设备的流量")]),a._v(" "),r("p",[a._v("信息，并以包含PNG格式的图形的HTML文档方式显示给用户。")]),a._v(" "),r("p",[a._v("cacti (仙人掌) 用php语言实现的一个软件，它的主要功能是用snmp")]),a._v(" "),r("p",[a._v("服务获取数据，然后用rrdtool储存和更新数据。官网地址: https://www.cacti.net/")]),a._v(" "),r("p",[a._v("ntop 官网地址: https://www.ntop.org/")]),a._v(" "),r("p",[a._v("nagios 能够跨平台,插件多,报警功能强大。官网地址: https://www.na")]),a._v(" "),r("p",[a._v("gios.org/")]),a._v(" "),r("p",[a._v("centreon 底层使用的就是nagios。是一个nagios整合版软件。官网")]),a._v(" "),r("p",[a._v("地址:https://www.centreon.com/")]),a._v(" "),r("p",[a._v("ganglia 设计用于测量数以千计的节点,资源消耗非常小。官网地址:htt")]),a._v(" "),r("p",[a._v("p://ganglia.info/")]),a._v(" "),r("p",[a._v("open-falcon 小米发布的运维监控软件，高效率，高可用。时间较")]),a._v(" "),r("p",[a._v("短，用户基数小。官网地址: http://open-falcon.org/zabbix 跨平台，画图，多条件告警，多种API接口。使用基数特别")]),a._v(" "),r("p",[a._v("大。官网地址: https://www.zabbix.com/")]),a._v(" "),r("p",[a._v("prometheus 基于时间序列的数值数据的容器监控解决方案。官网地")]),a._v(" "),r("p",[a._v("址: https://prometheus.io/")]),a._v(" "),r("p",[a._v("综合分析：Prometheus比较适合公司的监控需求")]),a._v(" "),r("h2",{attrs:{id:"一、普罗米修斯概述"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#一、普罗米修斯概述"}},[a._v("#")]),a._v(" 一、普罗米修斯概述")]),a._v(" "),r("p",[a._v("Prometheus(由go语言(golang)开发)是一套开源的监控&报警&时间序列数")]),a._v(" "),r("p",[a._v("据库的组合。适合监控docker容器。因为kubernetes(俗称k8s)的流行带动")]),a._v(" "),r("p",[a._v("了prometheus的发展。")]),a._v(" "),r("p",[a._v("https://prometheus.io/docs/introduction/overview/")]),a._v(" "),r("h2",{attrs:{id:"二、时间序列数据"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#二、时间序列数据"}},[a._v("#")]),a._v(" 二、时间序列数据")]),a._v(" "),r("h3",{attrs:{id:"_1、什么是序列数据"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1、什么是序列数据"}},[a._v("#")]),a._v(" 1、什么是序列数据")]),a._v(" "),r("p",[a._v("时间序列数据(TimeSeries Data) : 按照时间顺序记录系统、设备状态变化")]),a._v(" "),r("p",[a._v("的数据被称为时序数据。")]),a._v(" "),r("p",[a._v("应用的场景很多, 如：")]),a._v(" "),r("p",[a._v("无人驾驶车辆运行中要记录的经度，纬度，速度，方向，旁边物体的距")]),a._v(" "),r("p",[a._v("离等等。每时每刻都要将数据记录下来做分析。")]),a._v(" "),r("p",[a._v("某一个地区的各车辆的行驶轨迹数据")]),a._v(" "),r("p",[a._v("传统证券行业实时交易数据")]),a._v(" "),r("p",[a._v("实时运维监控数据等")]),a._v(" "),r("h3",{attrs:{id:"_2、时间序列数据特点"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2、时间序列数据特点"}},[a._v("#")]),a._v(" 2、时间序列数据特点")]),a._v(" "),r("p",[a._v("性能好")]),a._v(" "),r("p",[a._v("关系型数据库对于大规模数据的处理性能糟糕。NOSQL可以比较好的处理")]),a._v(" "),r("p",[a._v("大规模数据，让依然比不上时间序列数据库。")]),a._v(" "),r("p",[a._v("存储成本低高效的压缩算法，节省存储空间，有效降低IO")]),a._v(" "),r("p",[a._v("Prometheus有着非常高效的时间序列数据存储方法，每个采样数据仅仅占")]),a._v(" "),r("p",[a._v("用3.5byte左右空间，上百万条时间序列，30秒间隔，保留60天，大概花了")]),a._v(" "),r("p",[a._v("200多G（来自官方数据)")]),a._v(" "),r("h3",{attrs:{id:"_3、prometheus的主要特征"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3、prometheus的主要特征"}},[a._v("#")]),a._v(" 3、Prometheus的主要特征")]),a._v(" "),r("p",[a._v("多维度数据模型")]),a._v(" "),r("p",[a._v("灵活的查询语言")]),a._v(" "),r("p",[a._v("不依赖分布式存储，单个服务器节点是自主的")]),a._v(" "),r("p",[a._v("以HTTP方式，通过pull模型拉去时间序列数据")]),a._v(" "),r("p",[a._v("也可以通过中间网关支持push模型")]),a._v(" "),r("p",[a._v("通过服务发现或者静态配置，来发现目标服务对象")]),a._v(" "),r("p",[a._v("支持多种多样的图表和界面展示")]),a._v(" "),r("h3",{attrs:{id:"_4、普罗米修斯原理架构图"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4、普罗米修斯原理架构图"}},[a._v("#")]),a._v(" 4、普罗米修斯原理架构图")]),a._v(" "),r("p",[r("img",{attrs:{src:"https://i.loli.net/2020/01/08/MRzZUCjODXvipSP.png",alt:""}})]),a._v(" "),r("h2",{attrs:{id:"三、实验环境准备"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#三、实验环境准备"}},[a._v("#")]),a._v(" 三、实验环境准备")]),a._v(" "),r("h2",{attrs:{id:"_1-静态ip-要求能上外网"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1-静态ip-要求能上外网"}},[a._v("#")]),a._v(" 1. 静态ip(要求能上外网)")]),a._v(" "),r("ol",{attrs:{start:"2"}},[r("li",[a._v("主机名")]),a._v(" "),r("li",[a._v("时间同步(时间同步一定要确认一下)4. 关闭防火墙,selinux")])]),a._v(" "),r("h3",{attrs:{id:"_1、安装prometheus"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1、安装prometheus"}},[a._v("#")]),a._v(" 1、安装prometheus")]),a._v(" "),r("p",[a._v("从 https://prometheus.io/download/ 下载相应版本，安装到服务器上")]),a._v(" "),r("p",[a._v("官网提供的是二进制版，解压就能用，不需要编译")]),a._v(" "),r("p",[a._v("各自配置好主机名")]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v("\n")])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br")])]),r("p",[a._v("通过浏览器访问http://服务器IP:9090就可以访问到prometheus的主界面")]),a._v(" "),r("p",[a._v("默认只监控了本机一台，点Status --》点Targets --》可以看到只监控了本")]),a._v(" "),r("p",[a._v("机")]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v('[root@server ~]# tar xf prometheus-2.5.0.linux\n\namd64.tar.gz -C /usr/local/\n\n[root@server ~]# mv /usr/local/prometheus-2.5.0.linux\n\namd64/ /usr/local/prometheus\n\n直接使用默认配置文件启动\n\n[root@server ~]# /usr/local/prometheus/prometheus --\n\nconfig.file="/usr/local/prometheus/prometheus.yml" &\n\n确认端口(9090)\n\n[root@server ~]# lsof -i:90903、主机数据展示\n')])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br"),r("span",{staticClass:"line-number"},[a._v("2")]),r("br"),r("span",{staticClass:"line-number"},[a._v("3")]),r("br"),r("span",{staticClass:"line-number"},[a._v("4")]),r("br"),r("span",{staticClass:"line-number"},[a._v("5")]),r("br"),r("span",{staticClass:"line-number"},[a._v("6")]),r("br"),r("span",{staticClass:"line-number"},[a._v("7")]),r("br"),r("span",{staticClass:"line-number"},[a._v("8")]),r("br"),r("span",{staticClass:"line-number"},[a._v("9")]),r("br"),r("span",{staticClass:"line-number"},[a._v("10")]),r("br"),r("span",{staticClass:"line-number"},[a._v("11")]),r("br"),r("span",{staticClass:"line-number"},[a._v("12")]),r("br"),r("span",{staticClass:"line-number"},[a._v("13")]),r("br"),r("span",{staticClass:"line-number"},[a._v("14")]),r("br"),r("span",{staticClass:"line-number"},[a._v("15")]),r("br"),r("span",{staticClass:"line-number"},[a._v("16")]),r("br"),r("span",{staticClass:"line-number"},[a._v("17")]),r("br")])]),r("p",[a._v("通过http://服务器IP:9090/metrics可以查看到监控的数据")]),a._v(" "),r("p",[a._v("在web主界面可以通过关键字查询监控项4、监控远程Linux主机")]),a._v(" "),r("h3",{attrs:{id:"①-在远程linux主机-被监控端agent1-上安装node-exporter组件"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#①-在远程linux主机-被监控端agent1-上安装node-exporter组件"}},[a._v("#")]),a._v(" ① 在远程linux主机(被监控端agent1)上安装node_exporter组件")]),a._v(" "),r("p",[a._v("下载地址: https://prometheus.io/download/")]),a._v(" "),r("p",[a._v("扩展: nohup命令: 如果把启动node_exporter的终端给关闭,那么进程也会")]),a._v(" "),r("p",[a._v("随之关闭。nohup命令会帮你解决这个问题。")]),a._v(" "),r("h3",{attrs:{id:"②-通过浏览器访问http-被监控端ip-9100-metrics就可以查看到"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#②-通过浏览器访问http-被监控端ip-9100-metrics就可以查看到"}},[a._v("#")]),a._v(" ② 通过浏览器访问http://被监控端IP:9100/metrics就可以查看到")]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v("node_exporter在被监控端收集的监控信息\n\n[root@agent1 ~]# tar xf node_exporter-0.16.0.linux\n\namd64.tar.gz -C /usr/local/\n\n[root@agent1 ~]# mv /usr/local/node_exporter-0.16.0.linux\n\namd64/ /usr/local/node_exporter\n\n里面就一个启动命令node_exporter,可以直接使用此命令启动\n\n[root@agent1 ~]# ls /usr/local/node_exporter/\n\nLICENSE node_exporter NOTICE\n\n[root@agent1 ~]# nohup\n\n/usr/local/node_exporter/node_exporter &\n\n确认端口(9100)\n\n[root@agent1 ~]# lsof -i:9100③ 回到prometheus服务器的配置文件里添加被监控机器的配置段\n")])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br"),r("span",{staticClass:"line-number"},[a._v("2")]),r("br"),r("span",{staticClass:"line-number"},[a._v("3")]),r("br"),r("span",{staticClass:"line-number"},[a._v("4")]),r("br"),r("span",{staticClass:"line-number"},[a._v("5")]),r("br"),r("span",{staticClass:"line-number"},[a._v("6")]),r("br"),r("span",{staticClass:"line-number"},[a._v("7")]),r("br"),r("span",{staticClass:"line-number"},[a._v("8")]),r("br"),r("span",{staticClass:"line-number"},[a._v("9")]),r("br"),r("span",{staticClass:"line-number"},[a._v("10")]),r("br"),r("span",{staticClass:"line-number"},[a._v("11")]),r("br"),r("span",{staticClass:"line-number"},[a._v("12")]),r("br"),r("span",{staticClass:"line-number"},[a._v("13")]),r("br"),r("span",{staticClass:"line-number"},[a._v("14")]),r("br"),r("span",{staticClass:"line-number"},[a._v("15")]),r("br"),r("span",{staticClass:"line-number"},[a._v("16")]),r("br"),r("span",{staticClass:"line-number"},[a._v("17")]),r("br"),r("span",{staticClass:"line-number"},[a._v("18")]),r("br"),r("span",{staticClass:"line-number"},[a._v("19")]),r("br"),r("span",{staticClass:"line-number"},[a._v("20")]),r("br"),r("span",{staticClass:"line-number"},[a._v("21")]),r("br"),r("span",{staticClass:"line-number"},[a._v("22")]),r("br"),r("span",{staticClass:"line-number"},[a._v("23")]),r("br")])]),r("h3",{attrs:{id:"④-回到web管理界面-》点status-》点targets-》可以看到多了一台监"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#④-回到web管理界面-》点status-》点targets-》可以看到多了一台监"}},[a._v("#")]),a._v(" ④ 回到web管理界面 --》点Status --》点Targets --》可以看到多了一台监")]),a._v(" "),r("p",[a._v("控目标")]),a._v(" "),r("p",[a._v("在主配置文件最后加上下面三行")]),a._v(" "),r("p",[a._v("[root@server ~]# vim /usr/local/prometheus/prometheus.yml")]),a._v(" "),r("p",[a._v("- job_name: 'agent1' # 取一个job名称来代")]),a._v(" "),r("p",[a._v("表被监控的机器")]),a._v(" "),r("p",[a._v("static_configs:")]),a._v(" "),r("p",[a._v("- targets: ['10.1.1.14:9100'] # 这里改成被监控机器的IP，后面端口接9100")]),a._v(" "),r("p",[a._v("改完配置文件后,重启服务")]),a._v(" "),r("p",[a._v("[root@server ~]# pkill prometheus")]),a._v(" "),r("p",[a._v("[root@server ~]# lsof -i:9090 # 确认端口没有进程占用")]),a._v(" "),r("p",[a._v("[root@server ~]# /usr/local/prometheus/prometheus --")]),a._v(" "),r("p",[a._v('config.file="/usr/local/prometheus/prometheus.yml" &')]),a._v(" "),r("p",[a._v("[root@server ~]# lsof -i:9090 # 确认端口被占用，说")]),a._v(" "),r("p",[a._v("明重启成功")]),a._v(" "),r("p",[a._v("练习: 加上本机prometheus的监控")]),a._v(" "),r("p",[a._v("答: 在本机安装node_exporter，也使用上面的方式监控起来。")]),a._v(" "),r("h3",{attrs:{id:"_5、监控远程mysql"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5、监控远程mysql"}},[a._v("#")]),a._v(" 5、监控远程MySQL")]),a._v(" "),r("p",[a._v("① 在被管理机agent1上安装mysqld_exporter组件")]),a._v(" "),r("p",[a._v("下载地址: https://prometheus.io/download/")]),a._v(" "),r("p",[r("strong",[a._v("安装mysqld_exporter组件")])]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v("[root@agent1 ~]# tar xf mysqld_exporter-0.11.0.linux\n\namd64.tar.gz -C /usr/local/\n\n[root@agent1 ~]# mv /usr/local/mysqld_exporter-\n\n0.11.0.linux-amd64/ /usr/local/mysqld_exporter\n\n[root@agent1 ~]# ls /usr/local/mysqld_exporter/\n\nLICENSE mysqld_exporter NOTICE\n")])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br"),r("span",{staticClass:"line-number"},[a._v("2")]),r("br"),r("span",{staticClass:"line-number"},[a._v("3")]),r("br"),r("span",{staticClass:"line-number"},[a._v("4")]),r("br"),r("span",{staticClass:"line-number"},[a._v("5")]),r("br"),r("span",{staticClass:"line-number"},[a._v("6")]),r("br"),r("span",{staticClass:"line-number"},[a._v("7")]),r("br"),r("span",{staticClass:"line-number"},[a._v("8")]),r("br"),r("span",{staticClass:"line-number"},[a._v("9")]),r("br"),r("span",{staticClass:"line-number"},[a._v("10")]),r("br"),r("span",{staticClass:"line-number"},[a._v("11")]),r("br")])]),r("p",[a._v("安装mariadb数据库,并授权")]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v("[root@agent1 ~]# yum install mariadb\\* -y\n\n[root@agent1 ~]# systemctl restart mariadb\n\n[root@agent1 ~]# systemctl enable mariadb\n\n[root@agent1 ~]# mysql\n\nMariaDB [(none)]> grant select,replication client,process\n\nON *.* to 'mysql_monitor'@'localhost' identified by '123';\n")])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br"),r("span",{staticClass:"line-number"},[a._v("2")]),r("br"),r("span",{staticClass:"line-number"},[a._v("3")]),r("br"),r("span",{staticClass:"line-number"},[a._v("4")]),r("br"),r("span",{staticClass:"line-number"},[a._v("5")]),r("br"),r("span",{staticClass:"line-number"},[a._v("6")]),r("br"),r("span",{staticClass:"line-number"},[a._v("7")]),r("br"),r("span",{staticClass:"line-number"},[a._v("8")]),r("br"),r("span",{staticClass:"line-number"},[a._v("9")]),r("br"),r("span",{staticClass:"line-number"},[a._v("10")]),r("br"),r("span",{staticClass:"line-number"},[a._v("11")]),r("br")])]),r("p",[a._v("(注意:授权ip为localhost，因为不是prometheus服务器来直接找mariadb")]),a._v(" "),r("p",[a._v("获取数据，而是prometheus服务器找mysql_exporter,mysql_exporter")]),a._v(" "),r("p",[a._v("再找mariadb。所以这个localhost是指的mysql_exporter的IP)② 回到prometheus服务器的配置文件里添加被监控的mariadb的配置段")]),a._v(" "),r("h3",{attrs:{id:"③-回到web管理界面-》点status-》点targets-》可以看到监控"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#③-回到web管理界面-》点status-》点targets-》可以看到监控"}},[a._v("#")]),a._v(" ③ 回到web管理界面 --》点Status --》点Targets --》可以看到监控")]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v("mariadb了\n\nMariaDB [(none)]> flush privileges;\n\nMariaDB [(none)]> quit\n\n创建一个mariadb配置文件，写上连接的用户名与密码(和上面的授权的用户名\n\n和密码要对应)\n\n[root@agent1 ~]# vim /usr/local/mysqld_exporter/.my.cnf\n\n[client]\n\nuser=mysql_monitor\n\npassword=123\n\n启动mysqld_exporter\n\n[root@agent1 ~]# nohup\n\n/usr/local/mysqld_exporter/mysqld_exporter --config.my\n\ncnf=/usr/local/mysqld_exporter/.my.cnf &\n\n确认端口(9104)\n\n[root@agent1 ~]# lsof -i:9104\n\n在主配置文件最后再加上下面三行\n\n[root@server ~]# vim /usr/local/prometheus/prometheus.yml\n\n- job_name: 'agent1_mariadb' # 取一个job\n\n名称来代表被监控的mariadb\n\nstatic_configs:\n\n- targets: ['10.1.1.14:9104'] # 这里改成\n\n被监控机器的IP，后面端口接9104\n\n改完配置文件后,重启服务\n\n[root@server ~]# pkill prometheus\n\n[root@server ~]# lsof -i:9090\n\n[root@server ~]# /usr/local/prometheus/prometheus --\n\nconfig.file=\"/usr/local/prometheus/prometheus.yml\" &\n\n[root@server ~]# lsof -i:9090\n")])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br"),r("span",{staticClass:"line-number"},[a._v("2")]),r("br"),r("span",{staticClass:"line-number"},[a._v("3")]),r("br"),r("span",{staticClass:"line-number"},[a._v("4")]),r("br"),r("span",{staticClass:"line-number"},[a._v("5")]),r("br"),r("span",{staticClass:"line-number"},[a._v("6")]),r("br"),r("span",{staticClass:"line-number"},[a._v("7")]),r("br"),r("span",{staticClass:"line-number"},[a._v("8")]),r("br"),r("span",{staticClass:"line-number"},[a._v("9")]),r("br"),r("span",{staticClass:"line-number"},[a._v("10")]),r("br"),r("span",{staticClass:"line-number"},[a._v("11")]),r("br"),r("span",{staticClass:"line-number"},[a._v("12")]),r("br"),r("span",{staticClass:"line-number"},[a._v("13")]),r("br"),r("span",{staticClass:"line-number"},[a._v("14")]),r("br"),r("span",{staticClass:"line-number"},[a._v("15")]),r("br"),r("span",{staticClass:"line-number"},[a._v("16")]),r("br"),r("span",{staticClass:"line-number"},[a._v("17")]),r("br"),r("span",{staticClass:"line-number"},[a._v("18")]),r("br"),r("span",{staticClass:"line-number"},[a._v("19")]),r("br"),r("span",{staticClass:"line-number"},[a._v("20")]),r("br"),r("span",{staticClass:"line-number"},[a._v("21")]),r("br"),r("span",{staticClass:"line-number"},[a._v("22")]),r("br"),r("span",{staticClass:"line-number"},[a._v("23")]),r("br"),r("span",{staticClass:"line-number"},[a._v("24")]),r("br"),r("span",{staticClass:"line-number"},[a._v("25")]),r("br"),r("span",{staticClass:"line-number"},[a._v("26")]),r("br"),r("span",{staticClass:"line-number"},[a._v("27")]),r("br"),r("span",{staticClass:"line-number"},[a._v("28")]),r("br"),r("span",{staticClass:"line-number"},[a._v("29")]),r("br"),r("span",{staticClass:"line-number"},[a._v("30")]),r("br"),r("span",{staticClass:"line-number"},[a._v("31")]),r("br"),r("span",{staticClass:"line-number"},[a._v("32")]),r("br"),r("span",{staticClass:"line-number"},[a._v("33")]),r("br"),r("span",{staticClass:"line-number"},[a._v("34")]),r("br"),r("span",{staticClass:"line-number"},[a._v("35")]),r("br"),r("span",{staticClass:"line-number"},[a._v("36")]),r("br"),r("span",{staticClass:"line-number"},[a._v("37")]),r("br"),r("span",{staticClass:"line-number"},[a._v("38")]),r("br"),r("span",{staticClass:"line-number"},[a._v("39")]),r("br"),r("span",{staticClass:"line-number"},[a._v("40")]),r("br"),r("span",{staticClass:"line-number"},[a._v("41")]),r("br"),r("span",{staticClass:"line-number"},[a._v("42")]),r("br"),r("span",{staticClass:"line-number"},[a._v("43")]),r("br"),r("span",{staticClass:"line-number"},[a._v("44")]),r("br"),r("span",{staticClass:"line-number"},[a._v("45")]),r("br"),r("span",{staticClass:"line-number"},[a._v("46")]),r("br"),r("span",{staticClass:"line-number"},[a._v("47")]),r("br"),r("span",{staticClass:"line-number"},[a._v("48")]),r("br"),r("span",{staticClass:"line-number"},[a._v("49")]),r("br"),r("span",{staticClass:"line-number"},[a._v("50")]),r("br"),r("span",{staticClass:"line-number"},[a._v("51")]),r("br"),r("span",{staticClass:"line-number"},[a._v("52")]),r("br"),r("span",{staticClass:"line-number"},[a._v("53")]),r("br"),r("span",{staticClass:"line-number"},[a._v("54")]),r("br"),r("span",{staticClass:"line-number"},[a._v("55")]),r("br")])]),r("h2",{attrs:{id:"四、grafana可视化图形工具"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#四、grafana可视化图形工具"}},[a._v("#")]),a._v(" 四、Grafana可视化图形工具")]),a._v(" "),r("h3",{attrs:{id:"_1、什么是grafana"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1、什么是grafana"}},[a._v("#")]),a._v(" 1、什么是Grafana")]),a._v(" "),r("p",[a._v("Grafana是一个开源的度量分析和可视化工具，可以通过将采集的数据分析，查询，然后进行可视化的展示,并能实现报警。网址: https://grafana.com/")]),a._v(" "),r("h3",{attrs:{id:"_2、使用grafana连接prometheus"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2、使用grafana连接prometheus"}},[a._v("#")]),a._v(" 2、使用Grafana连接Prometheus")]),a._v(" "),r("p",[a._v("① 在grafana服务器上安装grafana下载地址:https://grafana.com/grafana/download")]),a._v(" "),r("p",[a._v("② 通过浏览器访问 http:// grafana服务器IP:3000就到了登录界面,使用默认的admin用户,admin密码就可以登陆了")]),a._v(" "),r("p",[a._v("我这里选择的rpm包，下载后直接yum安装就OK")]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v("[root@grafana ~]# yum installl grafana-5.3.4-1.x86_64.rpm -y\n")])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br")])]),r("p",[a._v("启动服务**")]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v("[root@grafana ~]# systemctl start grafana-server\n\n[root@grafana ~]# systemctl enable grafana-server\n\n确认端口(3000)\n\n[root@grafana ~]# lsof -i:3000\n")])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br"),r("span",{staticClass:"line-number"},[a._v("2")]),r("br"),r("span",{staticClass:"line-number"},[a._v("3")]),r("br"),r("span",{staticClass:"line-number"},[a._v("4")]),r("br"),r("span",{staticClass:"line-number"},[a._v("5")]),r("br"),r("span",{staticClass:"line-number"},[a._v("6")]),r("br"),r("span",{staticClass:"line-number"},[a._v("7")]),r("br")])]),r("p",[a._v("③ 下面我们把prometheus服务器收集的数据做为一个数据源添加到grafana,让grafana可以得到prometheus的数据。")]),a._v(" "),r("p",[a._v("④ 然后为添加好的数据源做图形显示")]),a._v(" "),r("p",[a._v("⑤ 保存")]),a._v(" "),r("p",[a._v("⑥ 最后在dashboard可以查看到")]),a._v(" "),r("p",[a._v("⑦ 匹配条件显示")]),a._v(" "),r("h3",{attrs:{id:"_3、grafana图形显示mysql监控数据"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3、grafana图形显示mysql监控数据"}},[a._v("#")]),a._v(" 3、Grafana图形显示MySQL监控数据")]),a._v(" "),r("p",[a._v("① 在grafana上修改配置文件,并下载安装mysql监控的dashboard（包含")]),a._v(" "),r("p",[a._v("相关json文件，这些json文件可以看作是开发人员开发的一个监控模板)")]),a._v(" "),r("p",[a._v("参考网址: https://github.com/percona/grafana-dashboards")]),a._v(" "),r("p",[a._v("② 在grafana图形界面导入相关json文件")]),a._v(" "),r("p",[a._v("在grafana配置文件里最后加上以下三行")]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v("[root@grafana ~]# vim /etc/grafana/grafana.ini\n\n[dashboards.json]\n\nenabled = true\n\npath = /var/lib/grafana/dashboards\n\n[root@grafana ~]# cd /var/lib/grafana/\n\n[root@grafana grafana]# git clone\n\nhttps://github.com/percona/grafana-dashboards.git\n\n[root@grafana grafana]# cp -r grafana\n\ndashboards/dashboards/ /var/lib/grafana/\n")])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br"),r("span",{staticClass:"line-number"},[a._v("2")]),r("br"),r("span",{staticClass:"line-number"},[a._v("3")]),r("br"),r("span",{staticClass:"line-number"},[a._v("4")]),r("br"),r("span",{staticClass:"line-number"},[a._v("5")]),r("br"),r("span",{staticClass:"line-number"},[a._v("6")]),r("br"),r("span",{staticClass:"line-number"},[a._v("7")]),r("br"),r("span",{staticClass:"line-number"},[a._v("8")]),r("br"),r("span",{staticClass:"line-number"},[a._v("9")]),r("br"),r("span",{staticClass:"line-number"},[a._v("10")]),r("br"),r("span",{staticClass:"line-number"},[a._v("11")]),r("br"),r("span",{staticClass:"line-number"},[a._v("12")]),r("br"),r("span",{staticClass:"line-number"},[a._v("13")]),r("br"),r("span",{staticClass:"line-number"},[a._v("14")]),r("br"),r("span",{staticClass:"line-number"},[a._v("15")]),r("br"),r("span",{staticClass:"line-number"},[a._v("16")]),r("br"),r("span",{staticClass:"line-number"},[a._v("17")]),r("br")])]),r("p",[r("strong",[a._v("重启grafana服务")])]),a._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[a._v("[root@grafana grafana]# systemctl restart grafana-server\n")])]),a._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[a._v("1")]),r("br")])]),r("p",[a._v("③ 点import导入后,报prometheus数据源找不到,因为这些json文件里默认")]),a._v(" "),r("p",[a._v("要找的就是叫Prometheus的数据源，但我们前面建立的数据源却是叫prometheus_data(坑啊)")]),a._v(" "),r("p",[a._v("那么请自行把原来的prometheus_data源改名为Prometheus即可(注意:")]),a._v(" "),r("p",[a._v("第一个字母P是大写)")]),a._v(" "),r("p",[a._v("然后再回去刷新,就有数据了(如下图所示) ④ 过段时间再看，就会有数据了(如下图所示)")]),a._v(" "),r("h3",{attrs:{id:"_4、grafana-onealert报警"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4、grafana-onealert报警"}},[a._v("#")]),a._v(" 4、Grafana+onealert报警")]),a._v(" "),r("p",[a._v("prometheus报警需要使用alertmanager这个组件，而且报警规则需要手")]),a._v(" "),r("p",[a._v("动编写(对运维来说不友好)。所以我这里选用grafana+onealert报警。")]),a._v(" "),r("p",[a._v("注意: 实现报警前把所有机器时间同步再检查一遍.")]),a._v(" "),r("p",[a._v("① 先在onealert里添加grafana应用(申请onealert账号在zabbix已经讲过)")]),a._v(" "),r("p",[a._v("② 配置通知策略")]),a._v(" "),r("p",[a._v("③ 在grafana增加通知通道")]),a._v(" "),r("p",[a._v("④ 现在可以去设置一个报警来测试了(这里以我们前面加的cpu负载监控来做测试)")]),a._v(" "),r("p",[a._v("⑤ 保存后就可以测试了")]),a._v(" "),r("p",[a._v("如果agent1上的cpu负载还没有到0.5，你可以试试0.1,或者运行一些程序把agent1负载调大。最终能测试报警成功。")]),a._v(" "),r("p",[a._v("最终的邮件报警效果：测试mysql链接数报警")]),a._v(" "),r("h3",{attrs:{id:"_5、总结报警不成功的可能原因"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5、总结报警不成功的可能原因"}},[a._v("#")]),a._v(" 5、总结报警不成功的可能原因")]),a._v(" "),r("p",[a._v("各服务器之间时间不同步，这样时序数据会出问题，也会造成报警出问题")]),a._v(" "),r("p",[a._v("必须写通知内容，留空内容是不会发报警的")]),a._v(" "),r("p",[a._v("修改完报警配置后，记得要点右上角的保存")]),a._v(" "),r("p",[a._v("保存配置后，需要由OK状态变为alerting状态才会报警(也就是说，你配置保存后，就已经是alerting状态是不会报警的)")]),a._v(" "),r("p",[a._v("grafana与onealert通信有问题")]),a._v(" "),r("h3",{attrs:{id:"_6、课外扩展"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_6、课外扩展"}},[a._v("#")]),a._v(" 6、课外扩展")]),a._v(" "),r("p",[a._v("prometheus目前还在发展中，很多相应的监控都需要开发。但在官网的")]),a._v(" "),r("p",[a._v("dashboard库中,也有一些官方和社区开发人员开发的dashboard可以直接")]),a._v(" "),r("p",[a._v("拿来用。示例:")]),a._v(" "),r("p",[a._v("有兴趣的同学可以下载几个尝试一下(不一定版本兼容,如果不兼容，可多试")]),a._v(" "),r("p",[a._v("几个不同版本)")])])}),[],!1,null,null,null);s.default=t.exports}}]);