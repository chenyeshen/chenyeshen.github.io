(window.webpackJsonp=window.webpackJsonp||[]).push([[169],{803:function(s,n,e){"use strict";e.r(n);var a=e(4),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"应用场景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#应用场景"}},[s._v("#")]),s._v(" 应用场景")]),s._v(" "),e("p",[s._v("有的时候，我们对于同一通道中的消息处理，会通过判断头信息或者消息内容来做一些差异化处理，比如：可能在消息头信息中带入消息版本号，然后通过if判断来执行不同的处理逻辑，其代码结构可能是这样的：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@StreamListener(value = TestTopic.INPUT)\npublic void receiveV1(String payload, @Header("version") String version) {\n    if("1.0".equals(version)) {\n        // Version 1.0\n    }\n    if("2.0".equals(version)) {\n        // Version 2.0\n    }\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("那么当消息处理逻辑复杂的时候，这段逻辑就会变得特别复杂。针对这个问题，在"),e("code",[s._v("@StreamListener")]),s._v("注解中提供了一个不错的属性"),e("code",[s._v("condition")]),s._v("，可以用来优化这样的处理结构。")]),s._v(" "),e("h2",{attrs:{id:"动手试试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#动手试试"}},[s._v("#")]),s._v(" 动手试试")]),s._v(" "),e("p",[s._v("下面通过编写一个简单的例子来具体体会一下这个属性的用法：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@EnableBinding(TestApplication.TestTopic.class)\n@SpringBootApplication\npublic class TestApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(TestApplication.class, args);\n    }\n\n    @RestController\n    static class TestController {\n\n        @Autowired\n        private TestTopic testTopic;\n\n        /**\n         * 消息生产接口\n         *\n         * @param message\n         * @return\n         */\n        @GetMapping("/sendMessage")\n        public String messageWithMQ(@RequestParam String message) {\n            testTopic.output().send(MessageBuilder.withPayload(message).setHeader("version", "1.0").build());\n            testTopic.output().send(MessageBuilder.withPayload(message).setHeader("version", "2.0").build());\n            return "ok";\n        }\n\n    }\n\n    /**\n     * 消息消费逻辑\n     */\n    @Slf4j\n    @Component\n    static class TestListener {\n\n        @StreamListener(value = TestTopic.INPUT, condition = "headers[\'version\']==\'1.0\'")\n        public void receiveV1(String payload, @Header("version") String version) {\n            log.info("Received v1 : " + payload + ", " + version);\n        }\n\n        @StreamListener(value = TestTopic.INPUT, condition = "headers[\'version\']==\'2.0\'")\n        public void receiveV2(String payload, @Header("version") String version) {\n            log.info("Received v2 : " + payload + ", " + version);\n        }\n\n    }\n\n    interface TestTopic {\n\n        String OUTPUT = "example-topic-output";\n        String INPUT = "example-topic-input";\n\n        @Output(OUTPUT)\n        MessageChannel output();\n\n        @Input(INPUT)\n        SubscribableChannel input();\n\n    }\n\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br")])]),e("p",[s._v("内容很简单，既包含了消息的生产，也包含了消息消费。在"),e("code",[s._v("/sendMessage")]),s._v("接口的定义中，发送了两条消息，一条消息的头信息中包含version=1.0，另外一条消息的头信息中包含version=2.0。在消息监听类"),e("code",[s._v("TestListener")]),s._v("中，对"),e("code",[s._v("TestTopic.INPUT")]),s._v("通道定义了两个"),e("code",[s._v("@StreamListener")]),s._v("，这两个监听逻辑有不同的condition，这里的表达式表示会根据消息头信息中的"),e("code",[s._v("version")]),s._v("值来做不同的处理逻辑分发。")]),s._v(" "),e("p",[s._v("在启动应用之前，还要记得配置一下输入输出通道对应的物理目标（exchange或topic名），比如：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("spring.cloud.stream.bindings.example-topic-input.destination=test-topic\nspring.cloud.stream.bindings.example-topic-input.group=stream-content-route\nspring.cloud.stream.bindings.example-topic-output.destination=test-topic\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("完成了上面配置之后，就可以启动应用，并尝试访问"),e("code",[s._v("localhost:8080/sendMessage?message=hello")]),s._v("接口来发送一个消息到MQ中了。此时可以看到类似下面的日志：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("2018-12-24 15:50:33.361  INFO 17683 --- [content-route-1] c.d.stream.TestApplication$TestListener  : Received v1 : hello, 1.0\n2018-12-24 15:50:33.363  INFO 17683 --- [content-route-1] c.d.stream.TestApplication$TestListener  : Received v2 : hello, 2.0\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("从日志中可以看到，两条带有不同头信息的消息，分别通过不同的监听处理逻辑输出了对应的日志打印。")])])}),[],!1,null,null,null);n.default=t.exports}}]);