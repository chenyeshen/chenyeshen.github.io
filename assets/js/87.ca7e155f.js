(window.webpackJsonp=window.webpackJsonp||[]).push([[87],{736:function(a,s,n){"use strict";n.r(s);var t=n(4),e=Object(t.a)({},(function(){var a=this,s=a.$createElement,n=a._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[n("h2",{attrs:{id:"背景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[a._v("#")]),a._v(" 背景")]),a._v(" "),n("p",[a._v("Loki的第一个稳定版本于2019年11月19日发布，是 Grafana Labs 团队最新的开源项目，是一个水平可扩展，高可用性，多租户的日志聚合系统。 Grafana 对 Loki 的描述如下：")]),a._v(" "),n("blockquote",[n("p",[a._v("Loki: like Prometheus, but for logs. Loki is a horizontally-scalable, highly-available, multi-tenant log aggregation system inspired by Prometheus. It is designed to be very cost effective and easy to operate. It does not index the contents of the logs, but rather a set of labels for each log stream.")])]),a._v(" "),n("p",[a._v("简单说，Loki 是专门用于聚集日志数据，重点是高可用性和可伸缩性。与竞争对手不同的是，它确实易于安装且资源效率极高。")]),a._v(" "),n("h2",{attrs:{id:"介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[a._v("#")]),a._v(" 介绍")]),a._v(" "),n("p",[a._v("与其他日志聚合系统相比，"),n("code",[a._v("Loki")]),a._v("具有下面的一些特性：")]),a._v(" "),n("ul",[n("li",[a._v("不对日志进行全文索引（vs ELK技）。通过存储压缩非结构化日志和仅索引元数据，Loki 操作起来会更简单，更省成本。")]),a._v(" "),n("li",[a._v("通过使用与 Prometheus 相同的标签记录流对日志进行索引和分组，这使得日志的扩展和操作效率更高。")]),a._v(" "),n("li",[a._v("特别适合储存 Kubernetes Pod 日志; 诸如 Pod 标签之类的元数据会被自动删除和编入索引。")]),a._v(" "),n("li",[a._v("受 Grafana 原生支持。")])]),a._v(" "),n("p",[a._v("Loki 由以下3个部分组成：")]),a._v(" "),n("ul",[n("li",[n("code",[a._v("loki")]),a._v("是主服务器，负责存储日志和处理查询。")]),a._v(" "),n("li",[n("code",[a._v("promtail")]),a._v("是代理，负责收集日志并将其发送给 loki 。")]),a._v(" "),n("li",[n("code",[a._v("Grafana")]),a._v("用于 UI 展示。")])]),a._v(" "),n("h2",{attrs:{id:"一、安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、安装"}},[a._v("#")]),a._v(" 一、安装")]),a._v(" "),n("p",[a._v("Docker-compose.yml 可以参考"),n("code",[a._v("Loki")]),a._v("的"),n("a",{attrs:{href:"https://github.com/grafana/loki/tree/master/production",target:"_blank",rel:"noopener noreferrer"}},[a._v("文档介绍"),n("OutboundLink")],1),a._v("，开箱即用。")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v('version: "3"\n\nnetworks:\n  loki:\n\nservices:\n  loki:\n    image: grafana/loki:latest\n    ports:\n      - "3100:3100"\n    command: -config.file=/etc/loki/local-config.yaml\n    networks:\n      - loki\n\n  promtail:\n    image: grafana/promtail:latest\n    volumes:\n      - /var/log:/var/log\n    command: -config.file=/etc/promtail/docker-config.yaml\n    networks:\n      - loki\n\n  grafana:\n    image: grafana/grafana:master\n    ports:\n      - "3000:3000"\n    networks:\n      - loki\n')])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br"),n("span",{staticClass:"line-number"},[a._v("14")]),n("br"),n("span",{staticClass:"line-number"},[a._v("15")]),n("br"),n("span",{staticClass:"line-number"},[a._v("16")]),n("br"),n("span",{staticClass:"line-number"},[a._v("17")]),n("br"),n("span",{staticClass:"line-number"},[a._v("18")]),n("br"),n("span",{staticClass:"line-number"},[a._v("19")]),n("br"),n("span",{staticClass:"line-number"},[a._v("20")]),n("br"),n("span",{staticClass:"line-number"},[a._v("21")]),n("br"),n("span",{staticClass:"line-number"},[a._v("22")]),n("br"),n("span",{staticClass:"line-number"},[a._v("23")]),n("br"),n("span",{staticClass:"line-number"},[a._v("24")]),n("br"),n("span",{staticClass:"line-number"},[a._v("25")]),n("br"),n("span",{staticClass:"line-number"},[a._v("26")]),n("br"),n("span",{staticClass:"line-number"},[a._v("27")]),n("br"),n("span",{staticClass:"line-number"},[a._v("28")]),n("br")])]),n("p",[a._v("然后直接使用 docker-compose 启动即可：")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("$ docker-compose up -d\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br")])]),n("h2",{attrs:{id:"二、使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、使用"}},[a._v("#")]),a._v(" 二、使用")]),a._v(" "),n("p",[a._v("安装完成后，访问节点的 3000 端口访问 grafana，默认情况下使用(admin:admin)访问 -> 选择添加数据源：")]),a._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/daixiaomao/Images/raw/master/img/20200815225658.png",alt:""}})]),a._v(" "),n("p",[a._v("在数据源列表中选择"),n("code",[a._v("Loki")]),a._v("，配置 Loki 源地址：")]),a._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/daixiaomao/Images/raw/master/img/20200815225712.png",alt:""}}),a._v("grafana-loki-dashsource-config")]),a._v(" "),n("p",[a._v("源地址配置"),n("code",[a._v("http://loki:3100")]),a._v("即可，保存。")]),a._v(" "),n("p",[a._v("保存完成后，切换到 grafana 左侧区域的"),n("code",[a._v("Explore")]),a._v("，即可进入到"),n("code",[a._v("Loki")]),a._v("的页面，点击"),n("code",[a._v("Log labels")]),a._v("就可以把当前系统采集的日志标签给显示出来，可以根据这些标签进行日志的过滤查询：")]),a._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/daixiaomao/Images/raw/master/img/20200815225746.png",alt:""}})]),a._v(" "),n("p",[a._v("图中显示的label是我自定义的 label，大家可以根据自己的业务需求定义自己的label。")]),a._v(" "),n("h2",{attrs:{id:"三、配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、配置"}},[a._v("#")]),a._v(" 三、配置")]),a._v(" "),n("p",[a._v("从上面的步骤已经可以一窥使用方法了，如果要使用起来，我们还需要了解如下信息：")]),a._v(" "),n("h3",{attrs:{id:"loki-的配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#loki-的配置"}},[a._v("#")]),a._v(" Loki 的配置")]),a._v(" "),n("p",[a._v("Loki的详细配置，可查看官方文档：https://github.com/grafana/loki/blob/master/docs/README.md")]),a._v(" "),n("p",[a._v("配置相关文档： https://github.com/grafana/loki/blob/v1.3.0/docs/configuration/README.md")]),a._v(" "),n("p",[a._v("我目前均保留了保留默认配置。")]),a._v(" "),n("h3",{attrs:{id:"promtail的配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#promtail的配置"}},[a._v("#")]),a._v(" promtail的配置")]),a._v(" "),n("p",[a._v("promtail 是 Loki 的官方支持的日志采集端，在需要采集日志的节点上运行采集日志，再统一发送到 Loki 进行处理。我们编写的大多是这一部分。")]),a._v(" "),n("p",[a._v("官方配置说明： https://github.com/grafana/loki/blob/v1.3.0/docs/clients/promtail/configuration.md")]),a._v(" "),n("p",[a._v("除了使用Promtail，社区还有很多采集日志的组件，比如fluentd、fluent bit等，都是比较优秀的。")]),a._v(" "),n("p",[a._v("这里是我的promtail配置，"),n("code",[a._v("bj1")]),a._v("是我的节点，在address等配置会域名解析成ip的方式。")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("server:\n  http_listen_address: bj1\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /etc/promtail/positions.yaml\n  sync_period: 10s\n\nclients:\n  - url: http://bj1:3100/loki/api/v1/push\n\nscrape_configs:\n- job_name: system\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n      job: system\n      app: system\n      node: bj1\n      __path__: /var/log/*log\n- job_name: cron\n  static_configs:\n  - targets:\n      - localhost\n    labels:\n      job: cron\n      app: cron\n      node: bj1\n      __path__: /var/local/log/cron/*log\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br"),n("span",{staticClass:"line-number"},[a._v("14")]),n("br"),n("span",{staticClass:"line-number"},[a._v("15")]),n("br"),n("span",{staticClass:"line-number"},[a._v("16")]),n("br"),n("span",{staticClass:"line-number"},[a._v("17")]),n("br"),n("span",{staticClass:"line-number"},[a._v("18")]),n("br"),n("span",{staticClass:"line-number"},[a._v("19")]),n("br"),n("span",{staticClass:"line-number"},[a._v("20")]),n("br"),n("span",{staticClass:"line-number"},[a._v("21")]),n("br"),n("span",{staticClass:"line-number"},[a._v("22")]),n("br"),n("span",{staticClass:"line-number"},[a._v("23")]),n("br"),n("span",{staticClass:"line-number"},[a._v("24")]),n("br"),n("span",{staticClass:"line-number"},[a._v("25")]),n("br"),n("span",{staticClass:"line-number"},[a._v("26")]),n("br"),n("span",{staticClass:"line-number"},[a._v("27")]),n("br"),n("span",{staticClass:"line-number"},[a._v("28")]),n("br"),n("span",{staticClass:"line-number"},[a._v("29")]),n("br"),n("span",{staticClass:"line-number"},[a._v("30")]),n("br"),n("span",{staticClass:"line-number"},[a._v("31")]),n("br")])]),n("h2",{attrs:{id:"四、选择器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四、选择器"}},[a._v("#")]),a._v(" 四、选择器")]),a._v(" "),n("p",[a._v("对于查询表达式的标签部分，将其包装在花括号中"),n("code",[a._v("{}")]),a._v("，然后使用键值对的语法来选择标签，多个标签表达式用逗号分隔，比如：")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v('{app="mysql",name="mysql-backup"}\n')])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br")])]),n("p",[a._v("目前支持以下标签匹配运算符：")]),a._v(" "),n("ul",[n("li",[n("code",[a._v("=")]),a._v("等于")]),a._v(" "),n("li",[n("code",[a._v("!=")]),a._v("不相等")]),a._v(" "),n("li",[n("code",[a._v("=~")]),a._v("正则表达式匹配")]),a._v(" "),n("li",[n("code",[a._v("!~")]),a._v("不匹配正则表达式")])]),a._v(" "),n("p",[a._v("比如：")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v('{name=~"mysql.+"}\n{name!~"mysql.+"}\n')])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br")])]),n("p",[a._v("适用于"),n("code",[a._v("Prometheus")]),a._v("标签选择器规则同样也适用于"),n("code",[a._v("Loki")]),a._v("日志流选择器。")])])}),[],!1,null,null,null);s.default=e.exports}}]);