(window.webpackJsonp=window.webpackJsonp||[]).push([[226],{871:function(s,e,a){"use strict";a.r(e);var r=a(4),t=Object(r.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("采用Spring Boot + Freemarker开发Web项目时，由于一些静态文件比较大，如果是在PC上访问影响不大，当在手机上访问时，特别是用流量访问时速度会慢很多，而且很耗流量。")]),s._v(" "),a("p",[s._v("通过对请求进行抓包，可以发现每次进入一个页面都需要加载静态文件，如果不差钱的公司可以将静态文件放在CDN上来加快访问速度，或者用Nginx来做静态文件的缓存。")]),s._v(" "),a("p",[s._v("今天给大家介绍一种其他的缓存优化方式，通过Spring的缓存机制来缓存静态文件，在Spring Boot中配置静态文件缓存只需要在配置文件中加入下面的配置即可：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 资源缓存时间，单位秒\nspring.resources.cache-period=604800 \n# 开启gzip压缩\nspring.resources.chain.gzipped=true \n# 启用缓存\nspring.resources.chain.cache=false\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("配置可以参考文档：https://docs.spring.io/spring-boot/docs/1.5.4.RELEASE/reference/htmlsingle/ 的SPRING RESOURCES HANDLING部分")]),s._v(" "),a("p",[s._v("加上缓存配置后我们访问页面后，被加载过的静态资源就会缓存起来，第二次访问时就不会再去重新请求下载了，通过抓包可以看出确实被缓存了。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/daixiaomao/Images/raw/master/img/image-20210405191135518.png",alt:"image-20210405191135518"}})]),s._v(" "),a("p",[s._v("在Size那列有from memory cache,资源被缓存在浏览器的内存中了，也有的文件会缓存在磁盘中，那就是from disk cache。")]),s._v(" "),a("p",[s._v("优化目的是达到了，但是有一个小问题没有解决，就是如果我的资源文件变了，比如css文件有修改，当我服务端发布之后，用户这边还是会存在缓存。")]),s._v(" "),a("p",[s._v("最好的效果时当文件有改变时或者说当服务端的程序重启之后，用户的请求需要下载服务端的最新资源，没有重启的时候就用缓存的内容，这样就能保证更改后用户能够马上看到最新的内容。")]),s._v(" "),a("p",[s._v("我们可以用版本号来解决这个问题，就是在静态资源后面加上一个版本号，当资源发生变化时将版本号也改变，这样就不会有问题了。")]),s._v(" "),a("p",[s._v("使用方式如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<link rel="stylesheet" href="css/main-app.css?version=${version!}"/>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("用法很简单，关键是version这个值从哪来呢？")]),s._v(" "),a("p",[s._v("用法很简单，关键是version这个值从哪来呢？")]),s._v(" "),a("p",[s._v("我们可以在启动前通过代码设置这个值：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('System.setProperty("version", version);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("这个值可以通过main方法的args传进来，在启动项目的脚本中动态传到程序中，启动脚本可以获取程序jar的MD5值作为版本号，这样当服务端的程序重启之后，版本号就变了，缓存就失效了。")]),s._v(" "),a("p",[s._v("然后在过滤器中获取这个值设置到request中就可以在每个页面中使用了")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('String version = System.getProperty("version");\nreq.setAttribute("version", version == null ? "1.0.0" : version);\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("除了这种参数传递的方式，大家还可以通过自定义打包的插件，在打包的时候将version替换成具体的内容也可以。")]),s._v(" "),a("p",[s._v("上面讲的方式是通过自己去生成version来控制文件的变更，其实Spring Mvc中已经提供了静态文件的版本管理功能，有二种方式，一种是通过资源的MD5来生成版本号，文件内容变了，MD5肯定也变了。另一种是在资源的前面加上版本号的路径。")]),s._v(" "),a("p",[s._v("##MD5\n在属性文件中增加下面的配置：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("spring.resources.chain.strategy.content.enabled=true\nspring.resources.chain.strategy.content.paths=/**\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("增加Url的处理：")]),s._v(" "),a("p",[s._v("增加Url的处理：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v('@ControllerAdvice\npublic class ControllerConfig {\n@Autowired\nResourceUrlProvider resourceUrlProvider;\n\n@ModelAttribute("urls")\npublic ResourceUrlProvider urls() {\n    return this.resourceUrlProvider;\n}\n}\n')])])]),a("p",[s._v("页面中使用方式如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<link rel="stylesheet" type="text/css" href="${urls.getForLookupPath(\'/css/main-app.css\')}">\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("编译之后就会变成下面的内容：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<link rel="stylesheet" type="text/css" href="/css/main-app-4v371326bb93ce4b611853a309b69b33.css">\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("版本号\n在属性文件中增加下面的配置：")]),s._v(" "),a("p",[s._v("版本号\n在属性文件中增加下面的配置：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("spring.resources.chain.strategy.fixed.enabled=true\nspring.resources.chain.strategy.fixed.paths=/js/**,/v1.0.0/**\nspring.resources.chain.strategy.fixed.version=v1.0.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("页面中使用方式如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<script type="text/javascript" src="${urls.getForLookupPath(\'/js/main.js\')}"><\/script>\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("编译之后就会变成下面的内容：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<script type="text/javascript" src="/v1.0.0/js/main.js"><\/script>\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("无论使用哪种方式，能实现效果，并且工作量不会太大即可，优化无止境，干就完了。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/daixiaomao/Images/raw/master/img/image-20210410154825305.png",alt:"image-20210410154825305"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/daixiaomao/Images/raw/master/img/src=http%3A%2F%2Fwww.08lr.cn%2Fuploads%2Fallimg%2F170513%2F1-1F513164126.jpg&refer=http%3A%2F%2Fwww.08lr.cn&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg",alt:"img"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/daixiaomao/Images/raw/master/img/image-20210410150907643.png",alt:"image-20210410150907643"}})])])}),[],!1,null,null,null);e.default=t.exports}}]);