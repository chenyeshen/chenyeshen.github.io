(window.webpackJsonp=window.webpackJsonp||[]).push([[128],{779:function(s,e,n){"use strict";n.r(e);var a=n(4),t=Object(a.a)({},(function(){var s=this,e=s.$createElement,n=s._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),n("p",[s._v("Redis **的 **主从复制 模式下，一旦 "),n("strong",[s._v("主节点")]),s._v(" 由于故障不能提供服务，需要手动将 "),n("strong",[s._v("从节点")]),s._v(" 晋升为 "),n("strong",[s._v("主节点")]),s._v("，同时还要通知 "),n("strong",[s._v("客户端")]),s._v(" 更新 "),n("strong",[s._v("主节点地址")]),s._v("，这种故障处理方式从一定程度上是无法接受的。"),n("code",[s._v("Redis 2.8")]),s._v(" 以后提供了 "),n("strong",[s._v("Redis Sentinel 哨兵机制")]),s._v(" 来解决这个问题。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://chenyeshen.oss-cn-shenzhen.aliyuncs.com/oneblog/article/20191203101310646.png",alt:"img"}})]),s._v(" "),n("h1",{attrs:{id:"正文"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#正文"}},[s._v("#")]),s._v(" 正文")]),s._v(" "),n("h2",{attrs:{id:"_1-redis高可用概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-redis高可用概述"}},[s._v("#")]),s._v(" 1. Redis高可用概述")]),s._v(" "),n("p",[s._v("在 "),n("code",[s._v("Web")]),s._v(" 服务器中，"),n("strong",[s._v("高可用")]),s._v(" 是指服务器可以 "),n("strong",[s._v("正常访问")]),s._v(" 的时间，衡量的标准是在 "),n("strong",[s._v("多长时间")]),s._v(" 内可以提供正常服务（"),n("code",[s._v("99.9%")]),s._v("、"),n("code",[s._v("99.99%")]),s._v("、"),n("code",[s._v("99.999%")]),s._v(" 等等）。在 "),n("code",[s._v("Redis")]),s._v(" 层面，"),n("strong",[s._v("高可用")]),s._v(" 的含义要宽泛一些，除了保证提供 "),n("strong",[s._v("正常服务")]),s._v("（如 "),n("strong",[s._v("主从分离")]),s._v("、"),n("strong",[s._v("快速容灾技术")]),s._v(" 等），还需要考虑 "),n("strong",[s._v("数据容量扩展")]),s._v("、"),n("strong",[s._v("数据安全")]),s._v(" 等等。")]),s._v(" "),n("p",[s._v("在 "),n("code",[s._v("Redis")]),s._v(" 中，实现 "),n("strong",[s._v("高可用")]),s._v(" 的技术主要包括 "),n("strong",[s._v("持久化")]),s._v("、"),n("strong",[s._v("复制")]),s._v("、"),n("strong",[s._v("哨兵")]),s._v(" 和 "),n("strong",[s._v("集群")]),s._v("，下面简单说明它们的作用，以及解决了什么样的问题：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("持久化")]),s._v("：持久化是 "),n("strong",[s._v("最简单的")]),s._v(" 高可用方法。它的主要作用是 "),n("strong",[s._v("数据备份")]),s._v("，即将数据存储在 "),n("strong",[s._v("硬盘")]),s._v("，保证数据不会因进程退出而丢失。")]),s._v(" "),n("li",[n("strong",[s._v("复制")]),s._v("：复制是高可用 "),n("code",[s._v("Redis")]),s._v(" 的基础，"),n("strong",[s._v("哨兵")]),s._v(" 和 "),n("strong",[s._v("集群")]),s._v(" 都是在 "),n("strong",[s._v("复制基础")]),s._v(" 上实现高可用的。复制主要实现了数据的多机备份以及对于读操作的负载均衡和简单的故障恢复。缺陷是故障恢复无法自动化、写操作无法负载均衡、存储能力受到单机的限制。")]),s._v(" "),n("li",[n("strong",[s._v("哨兵")]),s._v("：在复制的基础上，哨兵实现了 "),n("strong",[s._v("自动化")]),s._v(" 的 "),n("strong",[s._v("故障恢复")]),s._v("。缺陷是 "),n("strong",[s._v("写操作")]),s._v(" 无法 "),n("strong",[s._v("负载均衡")]),s._v("，"),n("strong",[s._v("存储能力")]),s._v(" 受到 "),n("strong",[s._v("单机")]),s._v(" 的限制。")]),s._v(" "),n("li",[n("strong",[s._v("集群")]),s._v("：通过集群，"),n("code",[s._v("Redis")]),s._v(" 解决了 "),n("strong",[s._v("写操作")]),s._v(" 无法 "),n("strong",[s._v("负载均衡")]),s._v(" 以及 "),n("strong",[s._v("存储能力")]),s._v(" 受到 "),n("strong",[s._v("单机限制")]),s._v(" 的问题，实现了较为 "),n("strong",[s._v("完善")]),s._v(" 的 "),n("strong",[s._v("高可用方案")]),s._v("。")])]),s._v(" "),n("h2",{attrs:{id:"_2-redis-sentinel的基本概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis-sentinel的基本概念"}},[s._v("#")]),s._v(" 2. Redis Sentinel的基本概念")]),s._v(" "),n("p",[n("code",[s._v("Redis Sentinel")]),s._v(" 是 "),n("code",[s._v("Redis")]),s._v(" "),n("strong",[s._v("高可用")]),s._v(" 的实现方案。"),n("code",[s._v("Sentinel")]),s._v(" 是一个管理多个 "),n("code",[s._v("Redis")]),s._v(" 实例的工具，它可以实现对 "),n("code",[s._v("Redis")]),s._v(" 的 "),n("strong",[s._v("监控")]),s._v("、"),n("strong",[s._v("通知")]),s._v("、"),n("strong",[s._v("自动故障转移")]),s._v("。下面先对 "),n("code",[s._v("Redis Sentinel")]),s._v(" 的 "),n("strong",[s._v("基本概念")]),s._v(" 进行简单的介绍。")]),s._v(" "),n("p",[s._v("基本名词说明：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("基本名词")]),s._v(" "),n("th",[s._v("逻辑结构")]),s._v(" "),n("th",[s._v("物理结构")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("Redis数据节点")]),s._v(" "),n("td",[s._v("主节点和从节点")]),s._v(" "),n("td",[s._v("主节点和从节点的进程")])]),s._v(" "),n("tr",[n("td",[s._v("主节点(master)")]),s._v(" "),n("td",[s._v("Redis主数据库")]),s._v(" "),n("td",[s._v("一个独立的Redis进程")])]),s._v(" "),n("tr",[n("td",[s._v("从节点(slave)")]),s._v(" "),n("td",[s._v("Redis从数据库")]),s._v(" "),n("td",[s._v("一个独立的Redis进程")])]),s._v(" "),n("tr",[n("td",[s._v("Sentinel节点")]),s._v(" "),n("td",[s._v("监控Redis数据节点")]),s._v(" "),n("td",[s._v("一个独立的Sentinel进程")])]),s._v(" "),n("tr",[n("td",[s._v("Sentinel节点集合")]),s._v(" "),n("td",[s._v("若干Sentinel节点的抽象组合")]),s._v(" "),n("td",[s._v("若干Sentinel节点进程")])]),s._v(" "),n("tr",[n("td",[s._v("Redis Sentinel")]),s._v(" "),n("td",[s._v("Redis高可用实现方案")]),s._v(" "),n("td",[s._v("Sentinel节点集合和Redis数据节点进程")])]),s._v(" "),n("tr",[n("td",[s._v("应用客户端")]),s._v(" "),n("td",[s._v("泛指一个或多个客户端")]),s._v(" "),n("td",[s._v("一个或者多个客户端进程或者线程")])])])]),s._v(" "),n("p",[s._v("如图所示，"),n("code",[s._v("Redis")]),s._v(" 的 "),n("strong",[s._v("主从复制模式")]),s._v(" 和 "),n("code",[s._v("Sentinel")]),s._v(" "),n("strong",[s._v("高可用架构")]),s._v(" 的示意图：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://i.loli.net/2019/12/03/eyn9QAfFEPDZXUK.png",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"_3-redis主从复制的问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-redis主从复制的问题"}},[s._v("#")]),s._v(" 3. Redis主从复制的问题")]),s._v(" "),n("p",[n("code",[s._v("Redis")]),s._v(" "),n("strong",[s._v("主从复制")]),s._v(" 可将 "),n("strong",[s._v("主节点")]),s._v(" 数据同步给 "),n("strong",[s._v("从节点")]),s._v("，从节点此时有两个作用：")]),s._v(" "),n("ol",[n("li",[s._v("一旦 "),n("strong",[s._v("主节点宕机")]),s._v("，"),n("strong",[s._v("从节点")]),s._v(" 作为 "),n("strong",[s._v("主节点")]),s._v(" 的 "),n("strong",[s._v("备份")]),s._v(" 可以随时顶上来。")]),s._v(" "),n("li",[s._v("扩展 "),n("strong",[s._v("主节点")]),s._v(" 的 "),n("strong",[s._v("读能力")]),s._v("，分担主节点读压力。")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://i.loli.net/2019/12/03/g5F9CKWJ2YdAmv4.png",alt:""}})]),s._v(" "),n("p",[n("strong",[s._v("主从复制")]),s._v(" 同时存在以下几个问题：")]),s._v(" "),n("ol",[n("li",[s._v("一旦 "),n("strong",[s._v("主节点宕机")]),s._v("，"),n("strong",[s._v("从节点")]),s._v(" 晋升成 "),n("strong",[s._v("主节点")]),s._v("，同时需要修改 "),n("strong",[s._v("应用方")]),s._v(" 的 "),n("strong",[s._v("主节点地址")]),s._v("，还需要命令所有 "),n("strong",[s._v("从节点")]),s._v(" 去 "),n("strong",[s._v("复制")]),s._v(" 新的主节点，整个过程需要 "),n("strong",[s._v("人工干预")]),s._v("。")]),s._v(" "),n("li",[n("strong",[s._v("主节点")]),s._v(" 的 "),n("strong",[s._v("写能力")]),s._v(" 受到 "),n("strong",[s._v("单机的限制")]),s._v("。")]),s._v(" "),n("li",[n("strong",[s._v("主节点")]),s._v(" 的 "),n("strong",[s._v("存储能力")]),s._v(" 受到 "),n("strong",[s._v("单机的限制")]),s._v("。")]),s._v(" "),n("li",[n("strong",[s._v("原生复制")]),s._v(" 的弊端在早期的版本中也会比较突出，比如："),n("code",[s._v("Redis")]),s._v(" "),n("strong",[s._v("复制中断")]),s._v(" 后，"),n("strong",[s._v("从节点")]),s._v(" 会发起 "),n("code",[s._v("psync")]),s._v("。此时如果 "),n("strong",[s._v("同步不成功")]),s._v("，则会进行 "),n("strong",[s._v("全量同步")]),s._v("，"),n("strong",[s._v("主库")]),s._v(" 执行 "),n("strong",[s._v("全量备份")]),s._v(" 的同时，可能会造成毫秒或秒级的 "),n("strong",[s._v("卡顿")]),s._v("。")])]),s._v(" "),n("h2",{attrs:{id:"_4-redis-sentinel深入探究"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-redis-sentinel深入探究"}},[s._v("#")]),s._v(" 4. Redis Sentinel深入探究")]),s._v(" "),n("h3",{attrs:{id:"_4-1-redis-sentinel的架构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-redis-sentinel的架构"}},[s._v("#")]),s._v(" 4.1. Redis Sentinel的架构")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://i.loli.net/2019/12/03/f5AFBWqz2m4TJ7Z.png",alt:""}})]),s._v(" "),n("h3",{attrs:{id:"_4-2-redis-sentinel的主要功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-redis-sentinel的主要功能"}},[s._v("#")]),s._v(" 4.2. Redis Sentinel的主要功能")]),s._v(" "),n("p",[n("code",[s._v("Sentinel")]),s._v(" 的主要功能包括 "),n("strong",[s._v("主节点存活检测")]),s._v("、"),n("strong",[s._v("主从运行情况检测")]),s._v("、"),n("strong",[s._v("自动故障转移")]),s._v(" （"),n("code",[s._v("failover")]),s._v("）、"),n("strong",[s._v("主从切换")]),s._v("。"),n("code",[s._v("Redis")]),s._v(" 的 "),n("code",[s._v("Sentinel")]),s._v(" 最小配置是 "),n("strong",[s._v("一主一从")]),s._v("。")]),s._v(" "),n("p",[n("code",[s._v("Redis")]),s._v(" 的 "),n("code",[s._v("Sentinel")]),s._v(" 系统可以用来管理多个 "),n("code",[s._v("Redis")]),s._v(" 服务器，该系统可以执行以下四个任务：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("监控")])])]),s._v(" "),n("p",[n("code",[s._v("Sentinel")]),s._v(" 会不断的检查 "),n("strong",[s._v("主服务器")]),s._v(" 和 "),n("strong",[s._v("从服务器")]),s._v(" 是否正常运行。")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("通知")])])]),s._v(" "),n("p",[s._v("当被监控的某个 "),n("code",[s._v("Redis")]),s._v(" 服务器出现问题，"),n("code",[s._v("Sentinel")]),s._v(" 通过 "),n("code",[s._v("API")]),s._v(" "),n("strong",[s._v("脚本")]),s._v(" 向 "),n("strong",[s._v("管理员")]),s._v(" 或者其他的 "),n("strong",[s._v("应用程序")]),s._v(" 发送通知。")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("自动故障转移")])])]),s._v(" "),n("p",[s._v("当 "),n("strong",[s._v("主节点")]),s._v(" 不能正常工作时，"),n("code",[s._v("Sentinel")]),s._v(" 会开始一次 "),n("strong",[s._v("自动的")]),s._v(" 故障转移操作，它会将与 "),n("strong",[s._v("失效主节点")]),s._v(" 是 "),n("strong",[s._v("主从关系")]),s._v(" 的其中一个 "),n("strong",[s._v("从节点")]),s._v(" 升级为新的 "),n("strong",[s._v("主节点")]),s._v("，并且将其他的 "),n("strong",[s._v("从节点")]),s._v(" 指向 "),n("strong",[s._v("新的主节点")]),s._v("。")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("配置提供者")])])]),s._v(" "),n("p",[s._v("在 "),n("code",[s._v("Redis Sentinel")]),s._v(" 模式下，"),n("strong",[s._v("客户端应用")]),s._v(" 在初始化时连接的是 "),n("code",[s._v("Sentinel")]),s._v(" "),n("strong",[s._v("节点集合")]),s._v("，从中获取 "),n("strong",[s._v("主节点")]),s._v(" 的信息。")]),s._v(" "),n("h3",{attrs:{id:"_4-3-主观下线和客观下线"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-主观下线和客观下线"}},[s._v("#")]),s._v(" 4.3. 主观下线和客观下线")]),s._v(" "),n("p",[s._v("默认情况下，"),n("strong",[s._v("每个")]),s._v(" "),n("code",[s._v("Sentinel")]),s._v(" 节点会以 "),n("strong",[s._v("每秒一次")]),s._v(" 的频率对 "),n("code",[s._v("Redis")]),s._v(" 节点和 "),n("strong",[s._v("其它")]),s._v(" 的 "),n("code",[s._v("Sentinel")]),s._v(" 节点发送 "),n("code",[s._v("PING")]),s._v(" 命令，并通过节点的 "),n("strong",[s._v("回复")]),s._v(" 来判断节点是否在线。")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("主观下线")])])]),s._v(" "),n("p",[n("strong",[s._v("主观下线")]),s._v(" 适用于所有 "),n("strong",[s._v("主节点")]),s._v(" 和 "),n("strong",[s._v("从节点")]),s._v("。如果在 "),n("code",[s._v("down-after-milliseconds")]),s._v(" 毫秒内，"),n("code",[s._v("Sentinel")]),s._v(" 没有收到 "),n("strong",[s._v("目标节点")]),s._v(" 的有效回复，则会判定 "),n("strong",[s._v("该节点")]),s._v(" 为 "),n("strong",[s._v("主观下线")]),s._v("。")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("客观下线")])])]),s._v(" "),n("p",[n("strong",[s._v("客观下线")]),s._v(" 只适用于 "),n("strong",[s._v("主节点")]),s._v("。如果 "),n("strong",[s._v("主节点")]),s._v(" 出现故障，"),n("code",[s._v("Sentinel")]),s._v(" 节点会通过 "),n("code",[s._v("sentinel is-master-down-by-addr")]),s._v(" 命令，向其它 "),n("code",[s._v("Sentinel")]),s._v(" 节点询问对该节点的 "),n("strong",[s._v("状态判断")]),s._v("。如果超过 "),n("code",[s._v("<quorum>")]),s._v(" 个数的节点判定 "),n("strong",[s._v("主节点")]),s._v(" 不可达，则该 "),n("code",[s._v("Sentinel")]),s._v(" 节点会判断 "),n("strong",[s._v("主节点")]),s._v(" 为 "),n("strong",[s._v("客观下线")]),s._v("。")]),s._v(" "),n("h3",{attrs:{id:"_4-4-sentinel的通信命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-sentinel的通信命令"}},[s._v("#")]),s._v(" 4.4. Sentinel的通信命令")]),s._v(" "),n("p",[n("code",[s._v("Sentinel")]),s._v(" 节点连接一个 "),n("code",[s._v("Redis")]),s._v(" 实例的时候，会创建 "),n("code",[s._v("cmd")]),s._v(" 和 "),n("code",[s._v("pub/sub")]),s._v(" 两个 "),n("strong",[s._v("连接")]),s._v("。"),n("code",[s._v("Sentinel")]),s._v(" 通过 "),n("code",[s._v("cmd")]),s._v(" 连接给 "),n("code",[s._v("Redis")]),s._v(" 发送命令，通过 "),n("code",[s._v("pub/sub")]),s._v(" 连接到 "),n("code",[s._v("Redis")]),s._v(" 实例上的其他 "),n("code",[s._v("Sentinel")]),s._v(" 实例。")]),s._v(" "),n("p",[n("code",[s._v("Sentinel")]),s._v(" 与 "),n("code",[s._v("Redis")]),s._v(" "),n("strong",[s._v("主节点")]),s._v(" 和 "),n("strong",[s._v("从节点")]),s._v(" 交互的命令，主要包括：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("命令")]),s._v(" "),n("th",[s._v("作 用")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("PING")]),s._v(" "),n("td",[n("code",[s._v("Sentinel")]),s._v(" 向 "),n("code",[s._v("Redis")]),s._v(" 节点发送 "),n("code",[s._v("PING")]),s._v(" 命令，检查节点的状态")])]),s._v(" "),n("tr",[n("td",[s._v("INFO")]),s._v(" "),n("td",[n("code",[s._v("Sentinel")]),s._v(" 向 "),n("code",[s._v("Redis")]),s._v(" 节点发送 "),n("code",[s._v("INFO")]),s._v(" 命令，获取它的 "),n("strong",[s._v("从节点信息")])])]),s._v(" "),n("tr",[n("td",[s._v("PUBLISH")]),s._v(" "),n("td",[n("code",[s._v("Sentinel")]),s._v(" 向其监控的 "),n("code",[s._v("Redis")]),s._v(" 节点 "),n("code",[s._v("__sentinel__:hello")]),s._v(" 这个 "),n("code",[s._v("channel")]),s._v(" 发布 "),n("strong",[s._v("自己的信息")]),s._v(" 及 "),n("strong",[s._v("主节点")]),s._v(" 相关的配置")])]),s._v(" "),n("tr",[n("td",[s._v("SUBSCRIBE")]),s._v(" "),n("td",[n("code",[s._v("Sentinel")]),s._v(" 通过订阅 "),n("code",[s._v("Redis")]),s._v(" "),n("strong",[s._v("主节点")]),s._v(" 和 "),n("strong",[s._v("从节点")]),s._v(" 的 "),n("code",[s._v("__sentinel__:hello")]),s._v(" 这个 "),n("code",[s._v("channnel")]),s._v("，获取正在监控相同服务的其他 "),n("code",[s._v("Sentinel")]),s._v(" 节点")])])])]),s._v(" "),n("p",[n("code",[s._v("Sentinel")]),s._v(" 与 "),n("code",[s._v("Sentinel")]),s._v(" 交互的命令，主要包括：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("命令")]),s._v(" "),n("th",[s._v("作 用")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("PING")]),s._v(" "),n("td",[n("code",[s._v("Sentinel")]),s._v(" 向其他 "),n("code",[s._v("Sentinel")]),s._v(" 节点发送 "),n("code",[s._v("PING")]),s._v(" 命令，检查节点的状态")])]),s._v(" "),n("tr",[n("td",[s._v("SENTINEL:is-master-down-by-addr")]),s._v(" "),n("td",[s._v("和其他 "),n("code",[s._v("Sentinel")]),s._v(" 协商 "),n("strong",[s._v("主节点")]),s._v(" 的状态，如果 "),n("strong",[s._v("主节点")]),s._v(" 处于 "),n("code",[s._v("SDOWN")]),s._v(" 状态，则投票自动选出新的 "),n("strong",[s._v("主节点")])])])])]),s._v(" "),n("h3",{attrs:{id:"_4-5-redis-sentinel的工作原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-redis-sentinel的工作原理"}},[s._v("#")]),s._v(" 4.5. Redis Sentinel的工作原理")]),s._v(" "),n("p",[s._v("每个 "),n("code",[s._v("Sentinel")]),s._v(" 节点都需要 "),n("strong",[s._v("定期执行")]),s._v(" 以下任务：")]),s._v(" "),n("ul",[n("li",[s._v("每个 "),n("code",[s._v("Sentinel")]),s._v(" 以 "),n("strong",[s._v("每秒钟")]),s._v(" 一次的频率，向它所知的 "),n("strong",[s._v("主服务器")]),s._v("、"),n("strong",[s._v("从服务器")]),s._v(" 以及其他 "),n("code",[s._v("Sentinel")]),s._v(" "),n("strong",[s._v("实例")]),s._v(" 发送一个 "),n("code",[s._v("PING")]),s._v(" 命令。")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://i.loli.net/2019/12/03/VnX9gHuvL6KmoBh.png",alt:""}})]),s._v(" "),n("ol",[n("li",[s._v("如果一个 "),n("strong",[s._v("实例")]),s._v("（"),n("code",[s._v("instance")]),s._v("）距离 "),n("strong",[s._v("最后一次")]),s._v(" 有效回复 "),n("code",[s._v("PING")]),s._v(" 命令的时间超过 "),n("code",[s._v("down-after-milliseconds")]),s._v(" 所指定的值，那么这个实例会被 "),n("code",[s._v("Sentinel")]),s._v(" 标记为 "),n("strong",[s._v("主观下线")]),s._v("。")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://i.loli.net/2019/12/03/zjsQpJYiXSPTWxI.png",alt:""}})]),s._v(" "),n("ol",[n("li",[n("p",[s._v("如果一个 "),n("strong",[s._v("主服务器")]),s._v(" 被标记为 "),n("strong",[s._v("主观下线")]),s._v("，那么正在 "),n("strong",[s._v("监视")]),s._v(" 这个 "),n("strong",[s._v("主服务器")]),s._v(" 的所有 "),n("code",[s._v("Sentinel")]),s._v(" 节点，要以 "),n("strong",[s._v("每秒一次")]),s._v(" 的频率确认 "),n("strong",[s._v("主服务器")]),s._v(" 的确进入了 "),n("strong",[s._v("主观下线")]),s._v(" 状态。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://i.loli.net/2019/12/03/IALbnzBygD46VGY.png",alt:""}})]),s._v(" "),n("p",[s._v("​")])]),s._v(" "),n("li",[n("p",[s._v("如果一个 "),n("strong",[s._v("主服务器")]),s._v(" 被标记为 "),n("strong",[s._v("主观下线")]),s._v("，并且有 "),n("strong",[s._v("足够数量")]),s._v(" 的 "),n("code",[s._v("Sentinel")]),s._v("（至少要达到 "),n("strong",[s._v("配置文件")]),s._v(" 指定的数量）在指定的 "),n("strong",[s._v("时间范围")]),s._v(" 内同意这一判断，那么这个 "),n("strong",[s._v("主服务器")]),s._v(" 被标记为 "),n("strong",[s._v("客观下线")]),s._v("。")])]),s._v(" "),n("li",[n("p",[s._v("在一般情况下， 每个 "),n("code",[s._v("Sentinel")]),s._v(" 会以每 "),n("code",[s._v("10")]),s._v(" 秒一次的频率，向它已知的所有 "),n("strong",[s._v("主服务器")]),s._v(" 和 "),n("strong",[s._v("从服务器")]),s._v(" 发送 "),n("code",[s._v("INFO")]),s._v(" 命令。当一个 "),n("strong",[s._v("主服务器")]),s._v(" 被 "),n("code",[s._v("Sentinel")]),s._v(" 标记为 "),n("strong",[s._v("客观下线")]),s._v(" 时，"),n("code",[s._v("Sentinel")]),s._v(" 向 "),n("strong",[s._v("下线主服务器")]),s._v(" 的所有 "),n("strong",[s._v("从服务器")]),s._v(" 发送 "),n("code",[s._v("INFO")]),s._v(" 命令的频率，会从 "),n("code",[s._v("10")]),s._v(" 秒一次改为 "),n("strong",[s._v("每秒一次")]),s._v("。")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("Sentinel")]),s._v(" 和其他 "),n("code",[s._v("Sentinel")]),s._v(" 协商 "),n("strong",[s._v("主节点")]),s._v(" 的状态，如果 "),n("strong",[s._v("主节点")]),s._v(" 处于 "),n("code",[s._v("SDOWN")]),s._v(" 状态，则投票自动选出新的 "),n("strong",[s._v("主节点")]),s._v("。将剩余的 "),n("strong",[s._v("从节点")]),s._v(" 指向 "),n("strong",[s._v("新的主节点")]),s._v(" 进行 "),n("strong",[s._v("数据复制")]),s._v("。")])]),s._v(" "),n("li",[n("p",[s._v("当没有足够数量的 "),n("code",[s._v("Sentinel")]),s._v(" 同意 "),n("strong",[s._v("主服务器")]),s._v(" 下线时， "),n("strong",[s._v("主服务器")]),s._v(" 的 "),n("strong",[s._v("客观下线状态")]),s._v(" 就会被移除。当 "),n("strong",[s._v("主服务器")]),s._v(" 重新向 "),n("code",[s._v("Sentinel")]),s._v(" 的 "),n("code",[s._v("PING")]),s._v(" 命令返回 "),n("strong",[s._v("有效回复")]),s._v(" 时，"),n("strong",[s._v("主服务器")]),s._v(" 的 "),n("strong",[s._v("主观下线状态")]),s._v(" 就会被移除。")])])]),s._v(" "),n("blockquote",[n("p",[s._v("注意：一个有效的 "),n("code",[s._v("PING")]),s._v(" 回复可以是："),n("code",[s._v("+PONG")]),s._v("、"),n("code",[s._v("-LOADING")]),s._v(" 或者 "),n("code",[s._v("-MASTERDOWN")]),s._v("。如果 "),n("strong",[s._v("服务器")]),s._v(" 返回除以上三种回复之外的其他回复，又或者在 "),n("strong",[s._v("指定时间")]),s._v(" 内没有回复 "),n("code",[s._v("PING")]),s._v(" 命令， 那么 "),n("code",[s._v("Sentinel")]),s._v(" 认为服务器返回的回复 "),n("strong",[s._v("无效")]),s._v("（"),n("code",[s._v("non-valid")]),s._v("）。")])]),s._v(" "),n("h2",{attrs:{id:"_5-redis-sentinel搭建"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-redis-sentinel搭建"}},[s._v("#")]),s._v(" 5. Redis Sentinel搭建")]),s._v(" "),n("h3",{attrs:{id:"_5-1-redis-sentinel的部署须知"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-redis-sentinel的部署须知"}},[s._v("#")]),s._v(" 5.1. Redis Sentinel的部署须知")]),s._v(" "),n("ol",[n("li",[s._v("一个稳健的 "),n("code",[s._v("Redis Sentinel")]),s._v(" 集群，应该使用至少 "),n("strong",[s._v("三个")]),s._v(" "),n("code",[s._v("Sentinel")]),s._v(" 实例，并且保证讲这些实例放到 "),n("strong",[s._v("不同的机器")]),s._v(" 上，甚至不同的 "),n("strong",[s._v("物理区域")]),s._v("。")]),s._v(" "),n("li",[n("code",[s._v("Sentinel")]),s._v(" 无法保证 "),n("strong",[s._v("强一致性")]),s._v("。")]),s._v(" "),n("li",[s._v("常见的 "),n("strong",[s._v("客户端应用库")]),s._v(" 都支持 "),n("code",[s._v("Sentinel")]),s._v("。")]),s._v(" "),n("li",[n("code",[s._v("Sentinel")]),s._v(" 需要通过不断的 "),n("strong",[s._v("测试")]),s._v(" 和 "),n("strong",[s._v("观察")]),s._v("，才能保证高可用。")])]),s._v(" "),n("h3",{attrs:{id:"_5-2-redis-sentinel的配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-redis-sentinel的配置文件"}},[s._v("#")]),s._v(" 5.2. Redis Sentinel的配置文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# 哨兵sentinel实例运行的端口，默认26379  \nport 26379\n# 哨兵sentinel的工作目录\ndir ./\n\n# 哨兵sentinel监控的redis主节点的 \n## ip：主机ip地址\n## port：哨兵端口号\n## master-name：可以自己命名的主节点名字（只能由字母A-z、数字0-9 、这三个字符".-_"组成。）\n## quorum：当这些quorum个数sentinel哨兵认为master主节点失联 那么这时 客观上认为主节点失联了  \n# sentinel monitor <master-name> <ip> <redis-port> <quorum>  \nsentinel monitor mymaster 127.0.0.1 6379 2\n\n# 当在Redis实例中开启了requirepass <foobared>，所有连接Redis实例的客户端都要提供密码。\n# sentinel auth-pass <master-name> <password>  \nsentinel auth-pass mymaster 123456  \n\n# 指定主节点应答哨兵sentinel的最大时间间隔，超过这个时间，哨兵主观上认为主节点下线，默认30秒  \n# sentinel down-after-milliseconds <master-name> <milliseconds>\nsentinel down-after-milliseconds mymaster 30000  \n\n# 指定了在发生failover主备切换时，最多可以有多少个slave同时对新的master进行同步。这个数字越小，完成failover所需的时间就越长；反之，但是如果这个数字越大，就意味着越多的slave因为replication而不可用。可以通过将这个值设为1，来保证每次只有一个slave，处于不能处理命令请求的状态。\n# sentinel parallel-syncs <master-name> <numslaves>\nsentinel parallel-syncs mymaster 1  \n\n# 故障转移的超时时间failover-timeout，默认三分钟，可以用在以下这些方面：\n## 1. 同一个sentinel对同一个master两次failover之间的间隔时间。  \n## 2. 当一个slave从一个错误的master那里同步数据时开始，直到slave被纠正为从正确的master那里同步数据时结束。  \n## 3. 当想要取消一个正在进行的failover时所需要的时间。\n## 4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来同步数据了\n# sentinel failover-timeout <master-name> <milliseconds>  \nsentinel failover-timeout mymaster 180000\n\n# 当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本。一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。\n# 对于脚本的运行结果有以下规则：  \n## 1. 若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10。\n## 2. 若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。  \n## 3. 如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。\n# sentinel notification-script <master-name> <script-path>  \nsentinel notification-script mymaster /var/redis/notify.sh\n\n# 这个脚本应该是通用的，能被多次调用，不是针对性的。\n# sentinel client-reconfig-script <master-name> <script-path>\nsentinel client-reconfig-script mymaster /var/redis/reconfig.sh\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br")])]),n("h3",{attrs:{id:"_5-3-redis-sentinel的节点规划"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-redis-sentinel的节点规划"}},[s._v("#")]),s._v(" 5.3. Redis Sentinel的节点规划")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("角色")]),s._v(" "),n("th",[s._v("IP地址")]),s._v(" "),n("th",[s._v("端口号")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("Redis Master")]),s._v(" "),n("td",[s._v("10.206.20.231")]),s._v(" "),n("td",[s._v("16379")])]),s._v(" "),n("tr",[n("td",[s._v("Redis Slave1")]),s._v(" "),n("td",[s._v("10.206.20.231")]),s._v(" "),n("td",[s._v("26379")])]),s._v(" "),n("tr",[n("td",[s._v("Redis Slave2")]),s._v(" "),n("td",[s._v("10.206.20.231")]),s._v(" "),n("td",[s._v("36379")])]),s._v(" "),n("tr",[n("td",[s._v("Redis Sentinel1")]),s._v(" "),n("td",[s._v("10.206.20.231")]),s._v(" "),n("td",[s._v("16380")])]),s._v(" "),n("tr",[n("td",[s._v("Redis Sentinel2")]),s._v(" "),n("td",[s._v("10.206.20.231")]),s._v(" "),n("td",[s._v("26380")])]),s._v(" "),n("tr",[n("td",[s._v("Redis Sentinel3")]),s._v(" "),n("td",[s._v("10.206.20.231")]),s._v(" "),n("td",[s._v("36380")])])])]),s._v(" "),n("h3",{attrs:{id:"_5-4-redis-sentinel的配置搭建"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-redis-sentinel的配置搭建"}},[s._v("#")]),s._v(" 5.4. Redis Sentinel的配置搭建")]),s._v(" "),n("h4",{attrs:{id:"_5-4-1-redis-server的配置管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-1-redis-server的配置管理"}},[s._v("#")]),s._v(" 5.4.1. Redis-Server的配置管理")]),s._v(" "),n("p",[s._v("分别拷贝三份 "),n("code",[s._v("redis.conf")]),s._v(" 文件到 "),n("code",[s._v("/usr/local/redis-sentinel")]),s._v(" 目录下面。三个配置文件分别对应 "),n("code",[s._v("master")]),s._v("、"),n("code",[s._v("slave1")]),s._v(" 和 "),n("code",[s._v("slave2")]),s._v(" 三个 "),n("code",[s._v("Redis")]),s._v(" 节点的 "),n("strong",[s._v("启动配置")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ sudo cp /usr/local/redis-4.0.11/redis.conf /usr/local/redis-sentinel/redis-16379.conf\n$ sudo cp /usr/local/redis-4.0.11/redis.conf /usr/local/redis-sentinel/redis-26379.conf\n$ sudo cp /usr/local/redis-4.0.11/redis.conf /usr/local/redis-sentinel/redis-36379.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("分别修改三份配置文件如下：")]),s._v(" "),n("ul",[n("li",[s._v("主节点：redis-16379.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("daemonize yes\npidfile /var/run/redis-16379.pid\nlogfile /var/log/redis/redis-16379.log\nport 16379\nbind 0.0.0.0\ntimeout 300\ndatabases 16\ndbfilename dump-16379.db\ndir ./redis-workdir\nmasterauth 123456\nrequirepass 123456\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("ul",[n("li",[s._v("从节点1：redis-26379.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("daemonize yes\npidfile /var/run/redis-26379.pid\nlogfile /var/log/redis/redis-26379.log\nport 26379\nbind 0.0.0.0\ntimeout 300\ndatabases 16\ndbfilename dump-26379.db\ndir ./redis-workdir\nmasterauth 123456\nrequirepass 123456\nslaveof 127.0.0.1 16379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("ul",[n("li",[s._v("从节点2：redis-36379.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("daemonize yes\npidfile /var/run/redis-36379.pid\nlogfile /var/log/redis/redis-36379.log\nport 36379\nbind 0.0.0.0\ntimeout 300\ndatabases 16\ndbfilename dump-36379.db\ndir ./redis-workdir\nmasterauth 123456\nrequirepass 123456\nslaveof 127.0.0.1 16379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("blockquote",[n("p",[s._v("如果要做 "),n("strong",[s._v("自动故障转移")]),s._v("，建议所有的 "),n("code",[s._v("redis.conf")]),s._v(" 都设置 "),n("code",[s._v("masterauth")]),s._v("。因为 "),n("strong",[s._v("自动故障")]),s._v(" 只会重写 "),n("strong",[s._v("主从关系")]),s._v("，即 "),n("code",[s._v("slaveof")]),s._v("，不会自动写入 "),n("code",[s._v("masterauth")]),s._v("。如果 "),n("code",[s._v("Redis")]),s._v(" 原本没有设置密码，则可以忽略。")])]),s._v(" "),n("h4",{attrs:{id:"_5-4-2-redis-server启动验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-2-redis-server启动验证"}},[s._v("#")]),s._v(" 5.4.2. Redis-Server启动验证")]),s._v(" "),n("p",[s._v("按顺序分别启动 "),n("code",[s._v("16379")]),s._v("，"),n("code",[s._v("26379")]),s._v(" 和 "),n("code",[s._v("36379")]),s._v(" 三个 "),n("code",[s._v("Redis")]),s._v(" 节点，启动命令和启动日志如下：")]),s._v(" "),n("p",[n("code",[s._v("Redis")]),s._v(" 的启动命令：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ sudo redis-server /usr/local/redis-sentinel/redis-16379.conf\n$ sudo redis-server /usr/local/redis-sentinel/redis-26379.conf\n$ sudo redis-server /usr/local/redis-sentinel/redis-36379.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("查看 "),n("code",[s._v("Redis")]),s._v(" 的启动进程：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ ps -ef | grep redis-server\n    0  7127     1   0  2:16下午 ??         0:01.84 redis-server 0.0.0.0:16379 \n    0  7133     1   0  2:16下午 ??         0:01.73 redis-server 0.0.0.0:26379 \n    0  7137     1   0  2:16下午 ??         0:01.70 redis-server 0.0.0.0:36379 \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("查看 "),n("code",[s._v("Redis")]),s._v(" 的启动日志：")]),s._v(" "),n("ul",[n("li",[s._v("节点 "),n("code",[s._v("redis-16379")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ cat /var/log/redis/redis-16379.log \n7126:C 22 Aug 14:16:38.907 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\n7126:C 22 Aug 14:16:38.908 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=7126, just started\n7126:C 22 Aug 14:16:38.908 # Configuration loaded\n7127:M 22 Aug 14:16:38.910 * Increased maximum number of open files to 10032 (it was originally set to 256).\n7127:M 22 Aug 14:16:38.912 * Running mode=standalone, port=16379.\n7127:M 22 Aug 14:16:38.913 # Server initialized\n7127:M 22 Aug 14:16:38.913 * Ready to accept connections\n7127:M 22 Aug 14:16:48.416 * Slave 127.0.0.1:26379 asks for synchronization\n7127:M 22 Aug 14:16:48.416 * Full resync requested by slave 127.0.0.1:26379\n7127:M 22 Aug 14:16:48.416 * Starting BGSAVE for SYNC with target: disk\n7127:M 22 Aug 14:16:48.416 * Background saving started by pid 7134\n7134:C 22 Aug 14:16:48.433 * DB saved on disk\n7127:M 22 Aug 14:16:48.487 * Background saving terminated with success\n7127:M 22 Aug 14:16:48.494 * Synchronization with slave 127.0.0.1:26379 succeeded\n7127:M 22 Aug 14:16:51.848 * Slave 127.0.0.1:36379 asks for synchronization\n7127:M 22 Aug 14:16:51.849 * Full resync requested by slave 127.0.0.1:36379\n7127:M 22 Aug 14:16:51.849 * Starting BGSAVE for SYNC with target: disk\n7127:M 22 Aug 14:16:51.850 * Background saving started by pid 7138\n7138:C 22 Aug 14:16:51.862 * DB saved on disk\n7127:M 22 Aug 14:16:51.919 * Background saving terminated with success\n7127:M 22 Aug 14:16:51.923 * Synchronization with slave 127.0.0.1:36379 succeeded\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("以下两行日志日志表明，"),n("code",[s._v("redis-16379")]),s._v(" 作为 "),n("code",[s._v("Redis")]),s._v(" 的 "),n("strong",[s._v("主节点")]),s._v("，"),n("code",[s._v("redis-26379")]),s._v(" 和 "),n("code",[s._v("redis-36379")]),s._v(" 作为 "),n("strong",[s._v("从节点")]),s._v("，从 "),n("strong",[s._v("主节点")]),s._v(" 同步数据。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("7127:M 22 Aug 14:16:48.416 * Slave 127.0.0.1:26379 asks for synchronization\n7127:M 22 Aug 14:16:51.848 * Slave 127.0.0.1:36379 asks for synchronization\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("节点 "),n("code",[s._v("redis-26379")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ cat /var/log/redis/redis-26379.log \n7132:C 22 Aug 14:16:48.407 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\n7132:C 22 Aug 14:16:48.408 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=7132, just started\n7132:C 22 Aug 14:16:48.408 # Configuration loaded\n7133:S 22 Aug 14:16:48.410 * Increased maximum number of open files to 10032 (it was originally set to 256).\n7133:S 22 Aug 14:16:48.412 * Running mode=standalone, port=26379.\n7133:S 22 Aug 14:16:48.413 # Server initialized\n7133:S 22 Aug 14:16:48.413 * Ready to accept connections\n7133:S 22 Aug 14:16:48.413 * Connecting to MASTER 127.0.0.1:16379\n7133:S 22 Aug 14:16:48.413 * MASTER <-> SLAVE sync started\n7133:S 22 Aug 14:16:48.414 * Non blocking connect for SYNC fired the event.\n7133:S 22 Aug 14:16:48.414 * Master replied to PING, replication can continue...\n7133:S 22 Aug 14:16:48.415 * Partial resynchronization not possible (no cached master)\n7133:S 22 Aug 14:16:48.417 * Full resync from master: 211d3b4eceaa3af4fe5c77d22adf06e1218e0e7b:0\n7133:S 22 Aug 14:16:48.494 * MASTER <-> SLAVE sync: receiving 176 bytes from master\n7133:S 22 Aug 14:16:48.495 * MASTER <-> SLAVE sync: Flushing old data\n7133:S 22 Aug 14:16:48.496 * MASTER <-> SLAVE sync: Loading DB in memory\n7133:S 22 Aug 14:16:48.498 * MASTER <-> SLAVE sync: Finished with success\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("节点 "),n("code",[s._v("redis-36379")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ cat /var/log/redis/redis-36379.log \n7136:C 22 Aug 14:16:51.839 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\n7136:C 22 Aug 14:16:51.840 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=7136, just started\n7136:C 22 Aug 14:16:51.841 # Configuration loaded\n7137:S 22 Aug 14:16:51.843 * Increased maximum number of open files to 10032 (it was originally set to 256).\n7137:S 22 Aug 14:16:51.845 * Running mode=standalone, port=36379.\n7137:S 22 Aug 14:16:51.845 # Server initialized\n7137:S 22 Aug 14:16:51.846 * Ready to accept connections\n7137:S 22 Aug 14:16:51.846 * Connecting to MASTER 127.0.0.1:16379\n7137:S 22 Aug 14:16:51.847 * MASTER <-> SLAVE sync started\n7137:S 22 Aug 14:16:51.847 * Non blocking connect for SYNC fired the event.\n7137:S 22 Aug 14:16:51.847 * Master replied to PING, replication can continue...\n7137:S 22 Aug 14:16:51.848 * Partial resynchronization not possible (no cached master)\n7137:S 22 Aug 14:16:51.850 * Full resync from master: 211d3b4eceaa3af4fe5c77d22adf06e1218e0e7b:14\n7137:S 22 Aug 14:16:51.923 * MASTER <-> SLAVE sync: receiving 176 bytes from master\n7137:S 22 Aug 14:16:51.923 * MASTER <-> SLAVE sync: Flushing old data\n7137:S 22 Aug 14:16:51.924 * MASTER <-> SLAVE sync: Loading DB in memory\n7137:S 22 Aug 14:16:51.927 * MASTER <-> SLAVE sync: Finished with success\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("h4",{attrs:{id:"_5-4-3-sentinel的配置管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-3-sentinel的配置管理"}},[s._v("#")]),s._v(" 5.4.3. Sentinel的配置管理")]),s._v(" "),n("p",[s._v("分别拷贝三份 "),n("code",[s._v("redis-sentinel.conf")]),s._v(" 文件到 "),n("code",[s._v("/usr/local/redis-sentinel")]),s._v(" 目录下面。三个配置文件分别对应 "),n("code",[s._v("master")]),s._v("、"),n("code",[s._v("slave1")]),s._v(" 和 "),n("code",[s._v("slave2")]),s._v(" 三个 "),n("code",[s._v("Redis")]),s._v(" 节点的 "),n("strong",[s._v("哨兵配置")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ sudo cp /usr/local/redis-4.0.11/sentinel.conf /usr/local/redis-sentinel/sentinel-16380.conf\n$ sudo cp /usr/local/redis-4.0.11/sentinel.conf /usr/local/redis-sentinel/sentinel-26380.conf\n$ sudo cp /usr/local/redis-4.0.11/sentinel.conf /usr/local/redis-sentinel/sentinel-36380.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("ul",[n("li",[s._v("节点1：sentinel-16380.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("protected-mode no\nbind 0.0.0.0\nport 16380\ndaemonize yes\nsentinel monitor master 127.0.0.1 16379 2\nsentinel down-after-milliseconds master 5000\nsentinel failover-timeout master 180000\nsentinel parallel-syncs master 1\nsentinel auth-pass master 123456\nlogfile /var/log/redis/sentinel-16380.log\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("ul",[n("li",[s._v("节点2：sentinel-26380.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("protected-mode no\nbind 0.0.0.0\nport 26380\ndaemonize yes\nsentinel monitor master 127.0.0.1 16379 2\nsentinel down-after-milliseconds master 5000\nsentinel failover-timeout master 180000\nsentinel parallel-syncs master 1\nsentinel auth-pass master 123456\nlogfile /var/log/redis/sentinel-26380.log\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("节点3：sentinel-36380.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("protected-mode no\nbind 0.0.0.0\nport 36380\ndaemonize yes\nsentinel monitor master 127.0.0.1 16379 2\nsentinel down-after-milliseconds master 5000\nsentinel failover-timeout master 180000\nsentinel parallel-syncs master 1\nsentinel auth-pass master 123456\nlogfile /var/log/redis/sentinel-36380.log\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h4",{attrs:{id:"_5-4-4-sentinel启动验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-4-sentinel启动验证"}},[s._v("#")]),s._v(" 5.4.4. Sentinel启动验证")]),s._v(" "),n("p",[s._v("按顺序分别启动 "),n("code",[s._v("16380")]),s._v("，"),n("code",[s._v("26380")]),s._v(" 和 "),n("code",[s._v("36380")]),s._v(" 三个 "),n("code",[s._v("Sentinel")]),s._v(" 节点，启动命令和启动日志如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ sudo redis-sentinel /usr/local/redis-sentinel/sentinel-16380.conf\n$ sudo redis-sentinel /usr/local/redis-sentinel/sentinel-26380.conf\n$ sudo redis-sentinel /usr/local/redis-sentinel/sentinel-36380.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("查看 "),n("code",[s._v("Sentinel")]),s._v(" 的启动进程：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ ps -ef | grep redis-sentinel\n    0  7954     1   0  3:30下午 ??         0:00.05 redis-sentinel 0.0.0.0:16380 [sentinel] \n    0  7957     1   0  3:30下午 ??         0:00.05 redis-sentinel 0.0.0.0:26380 [sentinel] \n    0  7960     1   0  3:30下午 ??         0:00.04 redis-sentinel 0.0.0.0:36380 [sentinel] \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("查看 "),n("code",[s._v("Sentinel")]),s._v(" 的启动日志：")]),s._v(" "),n("ul",[n("li",[s._v("节点 "),n("code",[s._v("sentinel-16380")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ cat /var/log/redis/sentinel-16380.log \n7953:X 22 Aug 15:30:27.245 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\n7953:X 22 Aug 15:30:27.245 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=7953, just started\n7953:X 22 Aug 15:30:27.245 # Configuration loaded\n7954:X 22 Aug 15:30:27.247 * Increased maximum number of open files to 10032 (it was originally set to 256).\n7954:X 22 Aug 15:30:27.249 * Running mode=sentinel, port=16380.\n7954:X 22 Aug 15:30:27.250 # Sentinel ID is 69d05b86a82102a8919231fd3c2d1f21ce86e000\n7954:X 22 Aug 15:30:27.250 # +monitor master master 127.0.0.1 16379 quorum 2\n7954:X 22 Aug 15:30:32.286 # +sdown sentinel fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7 127.0.0.1 36380 @ master 127.0.0.1 16379\n7954:X 22 Aug 15:30:34.588 # -sdown sentinel fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7 127.0.0.1 36380 @ master 127.0.0.1 16379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[n("code",[s._v("sentinel-16380")]),s._v(" 节点的 "),n("code",[s._v("Sentinel ID")]),s._v(" 为 "),n("code",[s._v("69d05b86a82102a8919231fd3c2d1f21ce86e000")]),s._v("，并通过 "),n("code",[s._v("Sentinel ID")]),s._v(" 把自身加入 "),n("code",[s._v("sentinel")]),s._v(" 集群中。")]),s._v(" "),n("ul",[n("li",[s._v("节点 "),n("code",[s._v("sentinel-26380")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ cat /var/log/redis/sentinel-26380.log \n7956:X 22 Aug 15:30:30.900 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\n7956:X 22 Aug 15:30:30.901 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=7956, just started\n7956:X 22 Aug 15:30:30.901 # Configuration loaded\n7957:X 22 Aug 15:30:30.904 * Increased maximum number of open files to 10032 (it was originally set to 256).\n7957:X 22 Aug 15:30:30.905 * Running mode=sentinel, port=26380.\n7957:X 22 Aug 15:30:30.906 # Sentinel ID is 21e30244cda6a3d3f55200bcd904d0877574e506\n7957:X 22 Aug 15:30:30.906 # +monitor master master 127.0.0.1 16379 quorum 2\n7957:X 22 Aug 15:30:30.907 * +slave slave 127.0.0.1:26379 127.0.0.1 26379 @ master 127.0.0.1 16379\n7957:X 22 Aug 15:30:30.911 * +slave slave 127.0.0.1:36379 127.0.0.1 36379 @ master 127.0.0.1 16379\n7957:X 22 Aug 15:30:36.311 * +sentinel sentinel fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7 127.0.0.1 36380 @ master 127.0.0.1 16379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[n("code",[s._v("sentinel-26380")]),s._v(" 节点的 "),n("code",[s._v("Sentinel ID")]),s._v(" 为 "),n("code",[s._v("21e30244cda6a3d3f55200bcd904d0877574e506")]),s._v("，并通过 "),n("code",[s._v("Sentinel ID")]),s._v(" 把自身加入 "),n("code",[s._v("sentinel")]),s._v(" 集群中。此时 "),n("code",[s._v("sentinel")]),s._v(" 集群中已有 "),n("code",[s._v("sentinel-16380")]),s._v(" 和 "),n("code",[s._v("sentinel-26380")]),s._v(" 两个节点。")]),s._v(" "),n("ul",[n("li",[s._v("节点 "),n("code",[s._v("sentinel-36380")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ cat /var/log/redis/sentinel-36380.log \n7959:X 22 Aug 15:30:34.273 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\n7959:X 22 Aug 15:30:34.274 # Redis version=4.0.11, bits=64, commit=00000000, modified=0, pid=7959, just started\n7959:X 22 Aug 15:30:34.274 # Configuration loaded\n7960:X 22 Aug 15:30:34.276 * Increased maximum number of open files to 10032 (it was originally set to 256).\n7960:X 22 Aug 15:30:34.277 * Running mode=sentinel, port=36380.\n7960:X 22 Aug 15:30:34.278 # Sentinel ID is fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7\n7960:X 22 Aug 15:30:34.278 # +monitor master master 127.0.0.1 16379 quorum 2\n7960:X 22 Aug 15:30:34.279 * +slave slave 127.0.0.1:26379 127.0.0.1 26379 @ master 127.0.0.1 16379\n7960:X 22 Aug 15:30:34.283 * +slave slave 127.0.0.1:36379 127.0.0.1 36379 @ master 127.0.0.1 16379\n7960:X 22 Aug 15:30:34.993 * +sentinel sentinel 21e30244cda6a3d3f55200bcd904d0877574e506 127.0.0.1 26380 @ master 127.0.0.1 16379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[n("code",[s._v("sentinel-36380")]),s._v(" 节点的 "),n("code",[s._v("Sentinel ID")]),s._v(" 为 "),n("code",[s._v("fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7")]),s._v("，并通过 "),n("code",[s._v("Sentinel ID")]),s._v(" 把自身加入 "),n("code",[s._v("sentinel")]),s._v(" 集群中。此时 "),n("code",[s._v("sentinel")]),s._v(" 集群中已有 "),n("code",[s._v("sentinel-16380")]),s._v("，"),n("code",[s._v("sentinel-26380")]),s._v(" 和 "),n("code",[s._v("sentinel-36380")]),s._v(" 三个节点。")]),s._v(" "),n("h4",{attrs:{id:"_5-4-5-sentinel配置刷新"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-5-sentinel配置刷新"}},[s._v("#")]),s._v(" 5.4.5. Sentinel配置刷新")]),s._v(" "),n("ul",[n("li",[s._v("节点1：sentinel-16380.conf")])]),s._v(" "),n("p",[n("code",[s._v("sentinel-16380.conf")]),s._v(" 文件新生成如下的配置项：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# Generated by CONFIG REWRITE\ndir "/usr/local/redis-sentinel"\nsentinel config-epoch master 0\nsentinel leader-epoch master 0\nsentinel known-slave master 127.0.0.1 36379\nsentinel known-slave master 127.0.0.1 26379\nsentinel known-sentinel master 127.0.0.1 26380 21e30244cda6a3d3f55200bcd904d0877574e506\nsentinel known-sentinel master 127.0.0.1 36380 fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7\nsentinel current-epoch 0\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("可以注意到，"),n("code",[s._v("sentinel-16380.conf")]),s._v(" 刷新写入了 "),n("code",[s._v("Redis")]),s._v(" 主节点关联的所有 "),n("strong",[s._v("从节点")]),s._v(" "),n("code",[s._v("redis-26379")]),s._v(" 和 "),n("code",[s._v("redis-36379")]),s._v("，同时写入了其余两个 "),n("code",[s._v("Sentinel")]),s._v(" 节点 "),n("code",[s._v("sentinel-26380")]),s._v(" 和 "),n("code",[s._v("sentinel-36380")]),s._v(" 的 "),n("code",[s._v("IP")]),s._v(" 地址，"),n("strong",[s._v("端口号")]),s._v(" 和 "),n("code",[s._v("Sentinel ID")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# Generated by CONFIG REWRITE\ndir "/usr/local/redis-sentinel"\nsentinel config-epoch master 0\nsentinel leader-epoch master 0\nsentinel known-slave master 127.0.0.1 26379\nsentinel known-slave master 127.0.0.1 36379\nsentinel known-sentinel master 127.0.0.1 36380 fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7\nsentinel known-sentinel master 127.0.0.1 16380 69d05b86a82102a8919231fd3c2d1f21ce86e000\nsentinel current-epoch 0\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("可以注意到，"),n("code",[s._v("sentinel-26380.conf")]),s._v(" 刷新写入了 "),n("code",[s._v("Redis")]),s._v(" 主节点关联的所有 "),n("strong",[s._v("从节点")]),s._v(" "),n("code",[s._v("redis-26379")]),s._v(" 和 "),n("code",[s._v("redis-36379")]),s._v("，同时写入了其余两个 "),n("code",[s._v("Sentinel")]),s._v(" 节点 "),n("code",[s._v("sentinel-36380")]),s._v(" 和 "),n("code",[s._v("sentinel-16380")]),s._v(" 的 "),n("code",[s._v("IP")]),s._v(" 地址，"),n("strong",[s._v("端口号")]),s._v(" 和 "),n("code",[s._v("Sentinel ID")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# Generated by CONFIG REWRITE\ndir "/usr/local/redis-sentinel"\nsentinel config-epoch master 0\nsentinel leader-epoch master 0\nsentinel known-slave master 127.0.0.1 36379\nsentinel known-slave master 127.0.0.1 26379\nsentinel known-sentinel master 127.0.0.1 16380 69d05b86a82102a8919231fd3c2d1f21ce86e000\nsentinel known-sentinel master 127.0.0.1 26380 21e30244cda6a3d3f55200bcd904d0877574e506\nsentinel current-epoch 0\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("可以注意到，"),n("code",[s._v("sentinel-36380.conf")]),s._v(" 刷新写入了 "),n("code",[s._v("Redis")]),s._v(" 主节点关联的所有 "),n("strong",[s._v("从节点")]),s._v(" "),n("code",[s._v("redis-26379")]),s._v(" 和 "),n("code",[s._v("redis-36379")]),s._v("，同时写入了其余两个 "),n("code",[s._v("Sentinel")]),s._v(" 节点 "),n("code",[s._v("sentinel-16380")]),s._v(" 和 "),n("code",[s._v("sentinel-26380")]),s._v(" 的 "),n("code",[s._v("IP")]),s._v(" 地址，"),n("strong",[s._v("端口号")]),s._v(" 和 "),n("code",[s._v("Sentinel ID")]),s._v("。")]),s._v(" "),n("h4",{attrs:{id:"_5-5-sentinel时客户端命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-sentinel时客户端命令"}},[s._v("#")]),s._v(" 5.5. Sentinel时客户端命令")]),s._v(" "),n("ul",[n("li",[s._v("检查其他 "),n("code",[s._v("Sentinel")]),s._v(" 节点的状态，返回 "),n("code",[s._v("PONG")]),s._v(" 为正常。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("> PING sentinel\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("显示被监控的所有 "),n("strong",[s._v("主节点")]),s._v(" 以及它们的状态。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("> SENTINEL masters\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("显示指定 "),n("strong",[s._v("主节点")]),s._v(" 的信息和状态。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("> SENTINEL master <master_name>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("显示指定 "),n("strong",[s._v("主节点")]),s._v(" 的所有 "),n("strong",[s._v("从节点")]),s._v(" 以及它们的状态。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("> SENTINEL slaves <master_name>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("返回指定 "),n("strong",[s._v("主节点")]),s._v(" 的 "),n("code",[s._v("IP")]),s._v(" 地址和 "),n("strong",[s._v("端口")]),s._v("。如果正在进行 "),n("code",[s._v("failover")]),s._v(" 或者 "),n("code",[s._v("failover")]),s._v(" 已经完成，将会显示被提升为 "),n("strong",[s._v("主节点")]),s._v(" 的 "),n("strong",[s._v("从节点")]),s._v(" 的 "),n("code",[s._v("IP")]),s._v(" 地址和 "),n("strong",[s._v("端口")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("> SENTINEL get-master-addr-by-name <master_name>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("重置名字匹配该 "),n("strong",[s._v("正则表达式")]),s._v(" 的所有的 "),n("strong",[s._v("主节点")]),s._v(" 的状态信息，清除它之前的 "),n("strong",[s._v("状态信息")]),s._v("，以及 "),n("strong",[s._v("从节点")]),s._v(" 的信息。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("> SENTINEL reset <pattern>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("强制当前 "),n("code",[s._v("Sentinel")]),s._v(" 节点执行 "),n("code",[s._v("failover")]),s._v("，并且不需要得到其他 "),n("code",[s._v("Sentinel")]),s._v(" 节点的同意。但是 "),n("code",[s._v("failover")]),s._v(" 后会将 "),n("strong",[s._v("最新的配置")]),s._v(" 发送给其他 "),n("code",[s._v("Sentinel")]),s._v(" 节点。")])]),s._v(" "),n("p",[s._v("​")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(">SENTINEL failover <master_name>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h2",{attrs:{id:"_6-redis-sentinel故障切换与恢复"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-redis-sentinel故障切换与恢复"}},[s._v("#")]),s._v(" 6. Redis Sentinel故障切换与恢复")]),s._v(" "),n("h3",{attrs:{id:"_6-1-redis-cli客户端跟踪"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-redis-cli客户端跟踪"}},[s._v("#")]),s._v(" 6.1. Redis CLI客户端跟踪")]),s._v(" "),n("p",[s._v("上面的日志显示，"),n("code",[s._v("redis-16379")]),s._v(" 节点为 "),n("strong",[s._v("主节点")]),s._v("，它的进程 "),n("code",[s._v("ID")]),s._v(" 为 "),n("code",[s._v("7127")]),s._v("。为了模拟 "),n("code",[s._v("Redis")]),s._v(" 主节点故障，强制杀掉这个进程。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ kill -9 7127\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("使用 "),n("code",[s._v("redis-cli")]),s._v(" 客户端命令进入 "),n("code",[s._v("sentinel-16380")]),s._v(" 节点，查看 "),n("code",[s._v("Redis")]),s._v(" "),n("strong",[s._v("节点")]),s._v(" 的状态信息。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ redis-cli -p 16380\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("查看 "),n("code",[s._v("Redis")]),s._v(" 主从集群的 "),n("strong",[s._v("主节点")]),s._v(" 信息。可以发现 "),n("code",[s._v("redis-26379")]),s._v(" 晋升为 "),n("strong",[s._v("新的主节点")]),s._v("。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('127.0.0.1:16380> SENTINEL master master\n 1) "name"\n 2) "master"\n 3) "ip"\n 4) "127.0.0.1"\n 5) "port"\n 6) "26379"\n 7) "runid"\n 8) "b8ca3b468a95d1be5efe1f50c50636cafe48c59f"\n 9) "flags"\n10) "master"\n11) "link-pending-commands"\n12) "0"\n13) "link-refcount"\n14) "1"\n15) "last-ping-sent"\n16) "0"\n17) "last-ok-ping-reply"\n18) "588"\n19) "last-ping-reply"\n20) "588"\n21) "down-after-milliseconds"\n22) "5000"\n23) "info-refresh"\n24) "9913"\n25) "role-reported"\n26) "master"\n27) "role-reported-time"\n28) "663171"\n29) "config-epoch"\n30) "1"\n31) "num-slaves"\n32) "2"\n33) "num-other-sentinels"\n34) "2"\n35) "quorum"\n36) "2"\n37) "failover-timeout"\n38) "180000"\n39) "parallel-syncs"\n40) "1"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br")])]),n("h3",{attrs:{id:"_6-2-redis-sentinel日志跟踪"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-redis-sentinel日志跟踪"}},[s._v("#")]),s._v(" 6.2. Redis Sentinel日志跟踪")]),s._v(" "),n("p",[s._v("查看任意 "),n("code",[s._v("Sentinel")]),s._v(" 节点的日志如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("7954:X 22 Aug 18:40:22.504 # +tilt #tilt mode entered\n7954:X 22 Aug 18:40:32.197 # +tilt #tilt mode entered\n7954:X 22 Aug 18:41:02.241 # -tilt #tilt mode exited\n7954:X 22 Aug 18:48:24.550 # +sdown master master 127.0.0.1 16379\n7954:X 22 Aug 18:48:24.647 # +new-epoch 1\n7954:X 22 Aug 18:48:24.651 # +vote-for-leader fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7 1\n7954:X 22 Aug 18:48:25.678 # +odown master master 127.0.0.1 16379 #quorum 3/2\n7954:X 22 Aug 18:48:25.678 # Next failover delay: I will not start a failover before Wed Aug 22 18:54:24 2018\n7954:X 22 Aug 18:48:25.709 # +config-update-from sentinel fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7 127.0.0.1 36380 @ master 127.0.0.1 16379\n7954:X 22 Aug 18:48:25.710 # +switch-master master 127.0.0.1 16379 127.0.0.1 26379\n7954:X 22 Aug 18:48:25.710 * +slave slave 127.0.0.1:36379 127.0.0.1 36379 @ master 127.0.0.1 26379\n7954:X 22 Aug 18:48:25.711 * +slave slave 127.0.0.1:16379 127.0.0.1 16379 @ master 127.0.0.1 26379\n7954:X 22 Aug 18:48:30.738 # +sdown slave 127.0.0.1:16379 127.0.0.1 16379 @ master 127.0.0.1 26379\n7954:X 22 Aug 19:38:23.479 # -sdown slave 127.0.0.1:16379 127.0.0.1 16379 @ master 127.0.0.1 26379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("ul",[n("li",[s._v("分析日志，可以发现 "),n("code",[s._v("redis-16329")]),s._v(" 节点先进入 "),n("code",[s._v("sdown")]),s._v(" "),n("strong",[s._v("主观下线")]),s._v(" 状态。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("+sdown master master 127.0.0.1 16379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("哨兵检测到 "),n("code",[s._v("redis-16329")]),s._v(" 出现故障，"),n("code",[s._v("Sentinel")]),s._v(" 进入一个 "),n("strong",[s._v("新纪元")]),s._v("，从 "),n("code",[s._v("0")]),s._v(" 变为 "),n("code",[s._v("1")]),s._v("。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("+new-epoch 1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("三个 "),n("code",[s._v("Sentinel")]),s._v(" 节点开始协商 "),n("strong",[s._v("主节点")]),s._v(" 的状态，判断其是否需要 "),n("strong",[s._v("客观下线")]),s._v("。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("+vote-for-leader fd166dc66425dc1d9e2670e1f17cb94fe05f5fc7 1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("超过 "),n("code",[s._v("quorum")]),s._v(" 个数的 "),n("code",[s._v("Sentinel")]),s._v(" 节点认为 "),n("strong",[s._v("主节点")]),s._v(" 出现故障，"),n("code",[s._v("redis-16329")]),s._v(" 节点进入 "),n("strong",[s._v("客观下线")]),s._v(" 状态。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("+odown master master 127.0.0.1 16379 #quorum 3/2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("Sentinal")]),s._v(" 进行 "),n("strong",[s._v("自动故障切换")]),s._v("，协商选定 "),n("code",[s._v("redis-26329")]),s._v(" 节点作为新的 "),n("strong",[s._v("主节点")]),s._v("。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("+switch-master master 127.0.0.1 16379 127.0.0.1 26379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("code",[s._v("redis-36329")]),s._v(" 节点和已经 "),n("strong",[s._v("客观下线")]),s._v(" 的 "),n("code",[s._v("redis-16329")]),s._v(" 节点成为 "),n("code",[s._v("redis-26479")]),s._v(" 的 "),n("strong",[s._v("从节点")]),s._v("。")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("7954:X 22 Aug 18:48:25.710 * +slave slave 127.0.0.1:36379 127.0.0.1 36379 @ master 127.0.0.1 26379\n7954:X 22 Aug 18:48:25.711 * +slave slave 127.0.0.1:16379 127.0.0.1 16379 @ master 127.0.0.1 26379\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"_6-3-redis的配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-redis的配置文件"}},[s._v("#")]),s._v(" 6.3. Redis的配置文件")]),s._v(" "),n("p",[s._v("分别查看三个 "),n("code",[s._v("redis")]),s._v(" 节点的配置文件，发生 "),n("strong",[s._v("主从切换")]),s._v(" 时 "),n("code",[s._v("redis.conf")]),s._v(" 的配置会自动发生刷新。")]),s._v(" "),n("ul",[n("li",[s._v("节点 redis-16379")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('daemonize yes\npidfile "/var/run/redis-16379.pid"\nlogfile "/var/log/redis/redis-16379.log"\nport 16379\nbind 0.0.0.0\ntimeout 300\ndatabases 16\ndbfilename "dump-16379.db"\ndir "/usr/local/redis-sentinel/redis-workdir"\nmasterauth "123456"\nrequirepass "123456"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("ul",[n("li",[s._v("节点 redis-26379")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('daemonize yes\npidfile "/var/run/redis-26379.pid"\nlogfile "/var/log/redis/redis-26379.log"\nport 26379\nbind 0.0.0.0\ntimeout 300\ndatabases 16\ndbfilename "dump-26379.db"\ndir "/usr/local/redis-sentinel/redis-workdir"\nmasterauth "123456"\nrequirepass "123456"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("节点 redis-36379")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('daemonize yes\npidfile "/var/run/redis-36379.pid"\nlogfile "/var/log/redis/redis-36379.log"\nport 36379\nbind 0.0.0.0\ntimeout 300\ndatabases 16\ndbfilename "dump-36379.db"\ndir "/usr/local/redis-sentinel/redis-workdir"\nmasterauth "123456"\nrequirepass "123456"\nslaveof 127.0.0.1 26379\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("blockquote",[n("p",[n("strong",[s._v("分析")]),s._v("："),n("code",[s._v("redis-26379")]),s._v(" 节点 "),n("code",[s._v("slaveof")]),s._v(" 配置被移除，晋升为 "),n("strong",[s._v("主节点")]),s._v("。"),n("code",[s._v("redis-16379")]),s._v(" 节点处于 "),n("strong",[s._v("宕机状态")]),s._v("。"),n("code",[s._v("redis-36379")]),s._v(" 的 "),n("code",[s._v("slaveof")]),s._v(" 配置更新为 "),n("code",[s._v("127.0.0.1 redis-26379")]),s._v("，成为 "),n("code",[s._v("redis-26379")]),s._v(" 的 "),n("strong",[s._v("从节点")]),s._v("。")])]),s._v(" "),n("p",[s._v("重启节点 "),n("code",[s._v("redis-16379")]),s._v("。待正常启动后，再次查看它的 "),n("code",[s._v("redis.conf")]),s._v(" 文件，配置如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('daemonize yes\npidfile "/var/run/redis-16379.pid"\nlogfile "/var/log/redis/redis-16379.log"\nport 16379\nbind 0.0.0.0\ntimeout 300\ndatabases 16\ndbfilename "dump-16379.db"\ndir "/usr/local/redis-sentinel/redis-workdir"\nmasterauth "123456"\nrequirepass "123456"\n# Generated by CONFIG REWRITE\nslaveof 127.0.0.1 26379\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("节点 "),n("code",[s._v("redis-16379")]),s._v(" 的配置文件新增一行 "),n("code",[s._v("slaveof")]),s._v(" 配置属性，指向 "),n("code",[s._v("redis-26379")]),s._v("，即成为 "),n("strong",[s._v("新的主节点")]),s._v(" 的 "),n("strong",[s._v("从节点")]),s._v("。")]),s._v(" "),n("h1",{attrs:{id:"小结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),n("p",[s._v("本文首先对 "),n("strong",[s._v("Redis "),n("strong",[s._v("实现高可用的几种模式做出了阐述，指出了")]),s._v(" Redis 主从复制")]),s._v(" 的不足之处，进一步引入了 "),n("strong",[s._v("Redis Sentinel 哨兵模式")]),s._v(" 的相关概念，深入说明了 "),n("code",[s._v("Redis Sentinel")]),s._v(" 的 "),n("strong",[s._v("具体功能")]),s._v("，"),n("strong",[s._v("基本原理")]),s._v("，"),n("strong",[s._v("高可用搭建")]),s._v(" 和 "),n("strong",[s._v("自动故障切换")]),s._v(" 验证等。")]),s._v(" "),n("p",[s._v("当然，"),n("code",[s._v("Redis Sentinel")]),s._v(" 仅仅解决了 "),n("strong",[s._v("高可用")]),s._v(" 的问题，对于 "),n("strong",[s._v("主节点")]),s._v(" 单点写入和单节点无法扩容等问题，还需要引入 "),n("strong",[s._v("Redis Cluster 集群模式")]),s._v(" 予以解决。")]),s._v(" "),n("p",[s._v("欢迎大家技术交流微信"),n("strong",[s._v("hsj179540")])])])}),[],!1,null,null,null);e.default=t.exports}}]);