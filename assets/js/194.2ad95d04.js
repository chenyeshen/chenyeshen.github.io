(window.webpackJsonp=window.webpackJsonp||[]).push([[194],{839:function(s,n,e){"use strict";e.r(n);var a=e(4),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"feign服务间相互调用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#feign服务间相互调用"}},[s._v("#")]),s._v(" "),e("strong",[s._v("Feign服务间相互调用")])]),s._v(" "),e("h3",{attrs:{id:"项目中访问方式大致分为以下三种"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#项目中访问方式大致分为以下三种"}},[s._v("#")]),s._v(" 项目中访问方式大致分为以下三种")]),s._v(" "),e("ol",[e("li",[s._v("外部从网关访问，需要鉴权。如后台的增删改查是最常用的，只要用户登录就可以了（有些接口可能需要加权限）")]),s._v(" "),e("li",[s._v("外部从网关访问，不需要鉴权，直接对外暴露无token访问。配置security.oauth2.client.release-urls就可以了")]),s._v(" "),e("li",[s._v("服务间Feign访问，不需要鉴权，但又不对外暴露，外部不能访问，只能服务之间访问（会传递token）。实现方式如下")])]),s._v(" "),e("p",[s._v("鉴于第三种情况，我们配置ignore-url和Feign，此时该接口不需要鉴权，服务内部通过Feign访问，服务外部通过url也可以访问，并不是我们想要的，所以我们通过在header中加入了一个from（SecurityConstants.FROM）参数来辨别是否内部调用。只有请求Header带有from参数时，才允许通过访问，否则抛出异常。那这样其实在外网通过Gateway访问时，也可以手动带上这个from参数来访问。所以需要在Gateway中设置了一个GlobalFilter过滤器，这个过滤器会删除请求头里的from参数。这样外部访问由于缺少头部信息，被拒绝访问；而服务间通过Feign访问，不经过Gateway，则可以正常访问。")]),s._v(" "),e("p",[s._v("使用场景：以上第三种情况，如A服务要调用B服务的方法")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("在B服务相应接口上使用@Inside注解，使得url无需鉴权（如：SysLogController.save方法）")]),s._v(" "),e("p",[s._v("@Inside的作用其实就是在项目加载时，获取有@Inside注解方法的uri，然后将这些uri自动加入到ignore-url中")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('/**\n * <p>\n * 日志表 前端控制器\n * </p>\n *\n * @author\n */\n@RestController\n@AllArgsConstructor\n@RequestMapping("/log")\n@Api(value = "log", tags = "日志管理模块")\npublic class SysLogController {\n    private final SysLogService sysLogService;\n\n    /**\n     * 插入日志\n     *\n     * @param sysLog 日志实体\n     * @return\n     */\n    @ApiOperation(value = "插入日志")\n    @Inside\n    @PostMapping("/save")\n    public R save(@Valid @RequestBody SysLog sysLog) {\n        return R.ok(sysLogService.save(sysLog));\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("在A服务编写Feign接口（如：FeignLogService）")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('//ServiceNameConstants.UMPS_ADMIN_SERVICE为相应的服务名\n@FeignClient(contextId = "feignLogService", value = ServiceNameConstants.UMPS_ADMIN_SERVICE)\npublic interface FeignLogService {\n    /**\n     * 保存日志\n     *\n     * @param sysLog 日志实体\n     * @param from   是否内部调用\n     * @return succes、false\n     */\n    @PostMapping("/log/save")\n    R<Boolean> saveLog(@RequestBody SysLog sysLog, @RequestHeader(SecurityConstants.FROM) String from);\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("在A服务调用接口（如：SysLogListener），带上SecurityConstants.FROM=SecurityConstants.FROM_IN参数指定为内部识别")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@Async\n@Order\n@EventListener(SysLogEvent.class)\npublic void saveSysLog(SysLogEvent event) {\n    SysLog sysLog = event.getSysLog();\n    reignLogService.saveLog(sysLog, SecurityConstants.FROM_IN);\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("以上就完成了A服务调用B服务的过程")])])]),s._v(" "),e("h3",{attrs:{id:"服务间的token传递"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#服务间的token传递"}},[s._v("#")]),s._v(" 服务间的token传递")]),s._v(" "),e("ul",[e("li",[s._v("Feign拦截器将上游服务的token传递给下游服务")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("public class BaseFeignClientInterceptor extends OAuth2FeignRequestInterceptor {\n\n\t/**\n\t * fein拦截器将本服务的token,通过copyToken的形式传递给下游服务\n\t * @param requestTemplate\n\t */\n\t@Override\n\tpublic void apply(RequestTemplate requestTemplate) {\n\t\tCollection<String> fromHeader = requestTemplate.headers().get(SecurityConstants.FROM);\n\t\tif (CollUtil.isNotEmpty(fromHeader) && fromHeader.contains(SecurityConstants.FROM_IN)) {\n\t\t\treturn;\n\t\t}\n\t\taccessTokenContextRelay.copyToken();\n\t\tif (oAuth2ClientContext != null\n\t\t\t&& oAuth2ClientContext.getAccessToken() != null) {\n\t\t\tsuper.apply(requestTemplate);\n\t\t}\n\t}\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);