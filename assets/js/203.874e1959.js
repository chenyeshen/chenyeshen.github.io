(window.webpackJsonp=window.webpackJsonp||[]).push([[203],{851:function(s,a,e){"use strict";e.r(a);var n=e(4),t=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"小程序订阅消息的使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小程序订阅消息的使用"}},[s._v("#")]),s._v(" "),e("strong",[s._v("小程序订阅消息的使用")])]),s._v(" "),e("h3",{attrs:{id:"joolun版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#joolun版本"}},[s._v("#")]),s._v(" JooLun版本")]),s._v(" "),e("ul",[e("li",[s._v("V2.8.2+")]),s._v(" "),e("li",[s._v("订阅消息发送核心方法（WxTemplateMsgServiceImpl.java）")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('/**\n * 发送微信订阅消息\n * @param wxTemplateMsgSendDTO wxTemplateMsgSendDTO.useType、wxTemplateMsgSendDTO.page、wxTemplateMsgSendDTO.data、\n * @param wxUser wxUser.appId、wxUser.openId、\n */\n@Override\npublic void sendWxTemplateMsg(WxTemplateMsgSendDTO wxTemplateMsgSendDTO, WxUser wxUser) {\n    //查询订阅消息配置\n    WxTemplateMsg wxTemplateMsg = baseMapper.selectOne(Wrappers.<WxTemplateMsg>lambdaQuery()\n            .eq(WxTemplateMsg::getAppId,wxUser.getAppId())\n            .eq(WxTemplateMsg::getEnable, CommonConstants.YES)\n            .eq(WxTemplateMsg::getUseType,wxTemplateMsgSendDTO.getUseType()));\n    if(wxTemplateMsg !=null){\n        WxMaMsgService wxMaMsgService = WxMaConfiguration.getMaService(wxTemplateMsg.getAppId()).getMsgService();\n        WxMaSubscribeMessage subscribeMessage = new WxMaSubscribeMessage();\n        subscribeMessage.setToUser(wxUser.getOpenId());\n        subscribeMessage.setTemplateId(wxTemplateMsg.getPriTmplId());\n        subscribeMessage.setPage(wxTemplateMsgSendDTO.getPage());\n        String content = wxTemplateMsg.getContent();\n        //提取模板中的参数\n        List<String> paramlist=new ArrayList<>();\n        Pattern p = Pattern.compile("(?<=\\\\{)[^\\\\}]+");\n        Matcher m = p.matcher(content);\n        while(m.find()){\n            paramlist.add(m.group().substring(1, m.group().length()));\n        }\n        List<WxMaSubscribeMessage.Data> listData = new ArrayList<>();\n        HashMap<String, HashMap<String, String>> dataMap = wxTemplateMsgSendDTO.getData();\n        paramlist.forEach(param -> {\n            param = param.replace(".DATA","");\n            if(dataMap.containsKey(param)){\n                WxMaSubscribeMessage.Data data = new WxMaSubscribeMessage.Data();\n                data.setName(param);\n                data.setValue(dataMap.get(param).get("value"));\n                listData.add(data);\n            }\n        });\n        subscribeMessage.setData(listData);\n        try {\n            wxMaMsgService.sendSubscribeMsg(subscribeMessage);\n        } catch (WxErrorException e) {\n            if(!WxReturnCode.ERR_43101.getCode().equals(e.getError().getErrorCode()+"")){\n                log.error(e.getMessage(),e);\n            }\n        }\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br")])]),e("ul",[e("li",[s._v("使用订阅消息发送功能，比如：用户订单支付成功后要发消息通知用户，实现方法如下： 1、微信公众平台申请模板")])]),s._v(" "),e("p",[e("a",{attrs:{href:"https://joolun-blog.oss-cn-zhangjiakou.aliyuncs.com/git/QQ%E6%88%AA%E5%9B%BE20200418220406.png",target:"_blank",rel:"noopener noreferrer"}},[e("img",{attrs:{src:"https://joolun-blog.oss-cn-zhangjiakou.aliyuncs.com/git/QQ%E6%88%AA%E5%9B%BE20200418220406.png",alt:"img"}}),e("OutboundLink")],1),s._v(" "),e("img",{attrs:{src:"https://joolun-blog.oss-cn-zhangjiakou.aliyuncs.com/git/QQ%E6%88%AA%E5%9B%BE20200418220740.png",alt:"img"}})]),s._v(" "),e("p",[s._v("2、将模板信息添加能JooLun后台，注：模板ID、模板内容一定要和微信公众平台申请的模板对应")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://joolun-blog.oss-cn-zhangjiakou.aliyuncs.com/git/QQ%E6%88%AA%E5%9B%BE20200418220959.png",target:"_blank",rel:"noopener noreferrer"}},[e("img",{attrs:{src:"https://joolun-blog.oss-cn-zhangjiakou.aliyuncs.com/git/QQ%E6%88%AA%E5%9B%BE20200418220959.png",alt:"img"}}),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("3、发送订阅消息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('//小程序端获取授权，参考：https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html\nlet tmplIds = [\'wetwqtwqyqwywq\',\'sgsdgsaetwetwqt\']\nwx.requestSubscribeMessage({\n  tmplIds: tmplIds,\n  success(res) {\n    console.log(res)\n  }\n})\n//后台发送订阅消息，参考：https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html\ntry {\n    WxTemplateMsgSendDTO wxTemplateMsgSendDTO = new WxTemplateMsgSendDTO();\n    wxTemplateMsgSendDTO.setMallUserId(orderInfo.getUserId());\n    wxTemplateMsgSendDTO.setUseType(ConfigConstant.WX_TMP_USE_TYPE_2);\n    wxTemplateMsgSendDTO.setPage("pages/order/order-detail/index?id="+orderInfo.getId());\n    HashMap<String, HashMap<String, String>> data = new HashMap<>();\n    data.put("character_string1", (HashMap)JSONUtil.toBean("{\\"value\\": \\""+orderInfo.getOrderNo()+"\\"}",Map.class));\n    DateTimeFormatter dtf = DateTimeFormatter.ofPattern("yyyy年MM月dd日 HH:mm");\n    data.put("time4", (HashMap)JSONUtil.toBean("{\\"value\\": \\""+orderInfo.getCreateTime().format(dtf)+"\\"}",Map.class));\n    String thing3 = orderInfo.getName();\n    thing3 = thing3.length() > 40 ? thing3.substring(0,39) : thing3;\n    data.put("thing3", (HashMap)JSONUtil.toBean("{\\"value\\": \\""+thing3+"\\"}",Map.class));\n    data.put("amount2", (HashMap)JSONUtil.toBean("{\\"value\\": \\""+orderInfo.getPaymentPrice()+"\\"}",Map.class));\n    data.put("amount5", (HashMap)JSONUtil.toBean("{\\"value\\": \\""+orderInfo.getPaymentPrice()+"\\"}",Map.class));\n    wxTemplateMsgSendDTO.setData(data);\n    feignWxTemplateMsgService.sendTemplateMsg(wxTemplateMsgSendDTO, SecurityConstants.FROM_IN);\n}catch (Exception e){\n    log.error("发送订阅消息发送出错："+e.getMessage(), e);\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br")])]),e("p",[s._v("4、相关说明")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://joolun-blog.oss-cn-zhangjiakou.aliyuncs.com/git/QQ%E6%88%AA%E5%9B%BE20200418221916.png",target:"_blank",rel:"noopener noreferrer"}},[e("img",{attrs:{src:"https://joolun-blog.oss-cn-zhangjiakou.aliyuncs.com/git/QQ%E6%88%AA%E5%9B%BE20200418221916.png",alt:"img"}}),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("5、源码中的模板")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("订单支付成功模板\n\n订单编号{{character_string1.DATA}}\n订单金额{{amount2.DATA}}\n商品名称{{thing3.DATA}}\n下单时间{{time4.DATA}}\n支付金额{{amount5.DATA}}\n订单发货提醒\n\n订单编号{{character_string1.DATA}}\n商品详情{{thing2.DATA}}\n快递单号{{character_string4.DATA}}\n收货人{{name5.DATA}}\n发货时间{{date10.DATA}}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("按以上模板参数值申请的模板无需修改代码，如自己申请的模板参数和源码默认的不同，按实际情况改下代码即可")])])}),[],!1,null,null,null);a.default=t.exports}}]);